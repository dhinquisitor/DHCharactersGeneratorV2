
<!-- saved from url=(0027)http://heresycreator.96.lt/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"><title>Whiplash450's Dark Heresy 2.0 Character Creator</title>

<meta name="description" content="Whiplash450&#39;s Dark Heresy 2nd Edition Character Creator">
<meta name="keywords" content="Dark, Heresy, 2nd, Edition, 2.0, Character, Creator, Generator">
<meta name="author" content="Whiplash450">
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />
<link rel="alternate" href="./dh_files/Whiplash450's Dark Heresy 2.0 Character Creator.html" hreflang="en">
<link rel="icon" type="image/ico" href="http://heresycreator.96.lt/favicon.ico">
<link href="./dh_files/bootstrap.min.css" rel="stylesheet">
<script async="" src="http://www.google-analytics.com/analytics.js"></script>
<script src="./dh_files/jquery-2.1.1.min.js"></script>
<script src="./dh_files/bootstrap.min.js"></script>
<script src="./dh_files/functions.js"></script>
<script src="./dh_files/nameArrays.js"></script>
<script src="./dh_files/descArrays.js"></script>
<script src="./dh_files/talent_array.js"></script>
<script src="./dh_files/list_talents.js"></script>
<script src="./dh_files/list_competence.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/t/bs-3.3.6/jq-2.2.0,dt-1.10.11,r-2.0.2/datatables.min.css"/>
 
<script type="text/javascript" src="https://cdn.datatables.net/t/bs-3.3.6/jq-2.2.0,dt-1.10.11,r-2.0.2/datatables.min.js"></script>

<script src="./dh_files/jspdf.min.js"></script>
<script src="./dh_files/adler32cs.js"></script>
<script src="./dh_files/FileSaver.min.js"></script>
<script src="./dh_files/BlobBuilder.min.js"></script>
<script src="./dh_files/jspdf.plugin.addimage.js"></script>
<script src="./dh_files/jspdf.plugin.standard_fonts_metrics.js"></script>
<script src="./dh_files/jspdf.plugin.split_text_to_size.js"></script>
<script src="./dh_files/json2.js"></script>
<script src="./dh_files/enoch.js"></script>

</head>

<body>
	<nav class="navbar navbar-default">
	  <ul class="nav nav-tabs">
		  <li role="presentation" class="active"><a href="dh.html">Générateur de personnage</a></li>
		  <li role="presentation" ><a href="talent.html">Liste des talents</a></li>
		  <li role="presentation" ><a href="competence.html">Liste des compétences</a></li>
		  <li role="presentation" ><a href="attribut_arme.html">Liste des attribut des armes</a></li>
		  <li role="presentation" ><a href="pouvoirs_psy.html" >Liste des pouvoirs psy</a></li>
		</ul>
	</nav>
<h1>&#8195;<img src="./dh_files/DH-logo_small.PNG" style="margin-top: -5px; width: 40px;">&#8195;Whiplash450's Dark Heresy 2nd Edition Character Creator&#8195;<img src="./dh_files/DH-logo_small.PNG" style="margin-top: -5px; width: 40px;"></h1>
<hr style="width: 100%; height: 1px;" noshade="">
&#8195;&#8195;<a target="_blank" href="http://www.reddit.com/r/40krpg/comments/2hfdll/dh_20_dark_heresy_2nded_character_generator_skill/"><img src="./dh_files/reddit.jpg" style="width: 30px; height: 30px;">&#8195;Link to 40kRpg Subreddit. This is where you'll find the list of updates and features still todo.</a>
<hr style="width: 100%; height: 1px;" NOSHADE/>
<div style="float:left">
&emsp;&emsp;<button id="button_save" class="btn btn-sm btn-success" style="display: inline; margin-top: -10px;" >Sauvegarder dans le navigateur</button>
&emsp;&emsp;<button id="button_load" class="btn btn-sm btn-primary" style="display: inline; margin-top: -10px;" >Recharger depuis le navigateur</button>
&emsp;&emsp;<button id="button_export" class="btn btn-sm btn-success" style="display: inline; margin-top: -10px;" >Exporter un PJ</button>
</div>
<div style="float:left">
	<span style="float:left">&emsp;&emsp; Importer un PJ  --></span><input style="margin-top:-10px" type="file" id="button_import" class="btn btn-sm  btn-primary" onchange="handleFiles(this.files)"  accept=".csv">
</div>


<hr style="width: 100%; height: 1px;" noshade="">
<!-- &emsp;<h3 style="display: inline">Choose Printing Type:&emsp;</h3>
DH 2.0 PC Sheet&emsp;<input id="radio_print_sheet" checked="checked" name="printtype" value="sheet" type="radio" style="width: 20px; height: 20px;"/>&emsp;&emsp;
Plain&emsp;<input id="radio_print_plain" name="printtype" value="plain" disabled type="radio" style="width: 20px; height: 20px;"/>&emsp;&emsp; -->
&#8195;<button id="button_testpdf" class="btn btn-danger" style="margin-top: -10px;">Print Character Sheet</button>&#8195;<i style="margin-top: -10px; color: red">(Work in progress!)</i><br><br>
&#8195;<h3 style="display: inline">1. Choose Gender:</h3>
	&#8195;Male&nbsp;&nbsp;<input id="radio_gender_male" checked="checked" name="gender" value="male" type="radio" style="width: 20px; height: 20px;">
	&#8195;Female&nbsp;&nbsp;<input id="radio_gender_female" name="gender" value="female" type="radio" style="width: 20px; height: 20px;">

&#8195;&#8195;&#8195;<h3 style="display: inline">2. Choose Name:</h3>&#8195;&#8195;<input id="box_name" class="form-control" style="display: inline; width: 200px;">
&#8195;<button id="button_namegenerate" class="btn btn-sm btn-primary">Generate&nbsp;&nbsp;<i class="glyphicon glyphicon-repeat"></i></button>
&#8195;<h3 id="nameError" style="color: red; display: none;">Pick a gender first!</h3>
<br><br>
&#8195;<h3 style="display: inline">3. Choose Homeworld:</h3>&#8195;&#8195;
<select id="select_world" class="form-control" style="width: 500px; display: inline;">
  <option disabled="" selected="">Select Homeworld</option>
  <option value="0">Monde sauvage (+S, +T, -infl -- Wounds: 9 -- Fate: 2 -- Aptitude: T)</option>
  <option value="1">Monde Forge (+T, +Int, -fel -- Wounds: 8 -- Fate: 3 -- Aptitude: Int)</option>
  <option value="2">Noble (+Fel, +Infl, -T -- Wounds: 9 -- Fate: 4 -- Aptitude: Fel)</option>
  <option value="3">Monde ruche (+Ag, +Per, -WP -- Wounds: 8 -- Fate: 2 -- Aptitude: Per)</option>
  <option value="4">Monde chapelle (+WP, +Fel, -Per -- Wounds: 7 -- Fate: 3 -- Aptitude: WP)</option>
  <option value="5">Hors monde (+Int, +WP, -S -- Wounds: 7 -- Fate: 3 -- Aptitude: Int)</option>
  <option value="6">Monde feudal (+Per, +WS, -Int -- Wounds: 9 -- Fate: 3 -- Aptitude: WS)</option>
  <option value="7">Monde des bordures (+BS, +Per, -Fel -- Wounds: 7 -- Fate: 3 -- Aptitude: BS)</option>
  <option value="8">AgriMonde (+Fel, +S, -Ag -- Wounds: 8 -- Fate: 2 -- Aptitude: S)</option>
  <option value="9">Monde Mortel(+Ag, +Per, -Fel -- Wounds: 9 -- Fate: 2 -- Aptitude: Fieldcraft)</option>
  <option value="10">Monde paradisiaque(+Fel, +Ag, -T -- Wounds: 7 -- Fate: 2 -- Aptitude: Social)</option>
  <option value="11">Station de recherche(+Int, +Per, -Fel -- Wounds: 8 -- Fate: 3 -- Aptitude: Knowledge)</option>
  <option value="12">Monde Demon(+WP, +Per, -Fel -- Wounds: 7 -- Fate: 3 -- Aptitude: WP)</option>
  <option value="13">Colonie pénale(+T, +Per, -Infl -- Wounds: 10 -- Fate: 3 -- Aptitude: T)</option>
  <option value="14">Monde en quarantaine(+BS, +Int, -S -- Wounds: 8 -- Fate: 3 -- Aptitude: Fieldcraft)</option>
</select>
<br><br>&#8195;&#8195;&#8195;<i>** Homeworld sets Favoured/Unfavoured stats, number of wounds, number of fate points and first Aptitude.</i>
<br><br>
&#8195;<h3 style="display: inline">4. Choose Background (&amp; Background Aptitude):</h3>&#8195;&#8195;
<select id="select_background" class="form-control" style="display: inline; width: 250px;">
	<option disabled="" selected="">Select Background</option>
	<option value="0">Adeptus Administratum</option>
	<option value="1">Adeptus Arbites</option>
	<option value="2">Adeptus Astra Telepathica</option>
	<option value="3">Adeptus Mechanicus</option>
	<option value="4">Adeptus Ministorum</option>
	<option value="5">Imperial Guard</option>
	<option value="6">Outcast</option>
	<option value="7">Adepta Sororitas</option>
	<option value="8">Mutant</option>
	<option value="9">Imperial Navy</option>
	<option value="10">Heretek</option>
	<option value="11">Rogue trader fleet</option>
</select>
&#8195;&#8195;<div id="div_bg_aptitude" style="display: inline;"></div>
<br><br>
&#8195;<h3 style="display: inline">5. Choose Role:</h3>&#8195;&#8195;
<select id="select_roles" class="form-control" style="display: inline; width: 210px;">
  <option disabled="" selected="">Select Background First!</option>
</select>
&#8195;&#8195;<i>** Denotes recommendation from your Background choice. This is due to linking Aptitudes to the Skills &amp; Talents from Roles</i>
<br><br>
  <div id="div_noxpeliteerror" style="display: none;">
    <h3 style="color: red">&#8195;&#8195;** NOT ENOUGH XP LEFT FOR UPGRADE **</h3>
  </div>
&#8195;<h3 style="display: inline">5.5 Amélioration d'élite (optionnel):</h3>
<select id="select_elite_advance" class="form-control" style="display: inline; width: 250px;">
	<option value="">Selectionner une amélioration</option>
	<option value="1" data-aptitude="15" data-xp="300">Astropathe</option>
	<option value="2" data-aptitude="18" data-xp="1000">Inquisiteur</option>
	<option value="3" data-xp="300">Intouchable</option>
	<option value="4" data-aptitude="15" data-xp="300">Psyker</option>
	<option value="5" data-aptitude="8" data-xp="300">Soeur de bataille</option>
</select><br/><br/>
<div class="well" style="margin-left: 10px; width: 99%;">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Background Skills</th>
            </tr>
          </thead>
          <tbody id="tbody_startingskills">  
          </tbody>
        </table>
      </div>
      <div class="col-md-3">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Homeworld Talents</th>
            </tr>
          </thead>
          <tbody id="tbody_worldtalents">
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Background Talents</th>
            </tr>
          </thead>
          <tbody id="tbody_startingtalents">  
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Role Talents</th>
            </tr>
          </thead>
          <tbody id="tbody_roletalents">  
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Divination <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i>
              <button id="button_divination_pick" disabled="" class="btn btn-xs btn-success" style="float: right;">Pick</button><i style="float: right;">&#8195;</i>
              <button id="button_divination_reroll" disabled="" class="btn btn-xs btn-primary" style="float: right;">Re-roll</button></th>
            </tr>
          </thead>
          <tbody id="tbody_divination">  
          </tbody>
        </table>        
      </div>
      <div class="col-md-3">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Starting Equipment</th>
            </tr>
          </thead>
          <tbody id="tbody_startingequip">  
          </tbody>
        </table>
      </div>
      <div class="col-md-3">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Homeworld Bonus <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
            </tr>
          </thead>
          <tbody id="tbody_startingworldbonus">  
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Background Bonus <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
            </tr>
          </thead>
          <tbody id="tbody_startingbgbonus">  
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Role Bonus <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
            </tr>
          </thead>
          <tbody id="tbody_rolebonus">
          </tbody>
        </table>
      </div>
      <!-- <div class="col-md-2">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Recommended Roles</th>
            </tr>
          </thead>
          <tbody id="tbody_recroles">  
          </tbody>
        </table>
      </div> -->
    </div>
  </div>
</div><br/><br/>
&#8195;<h3 style="display: inline">6. Aptitudes:</h3>&#8195;&#8195;<i>** Aptitudes are prerequisites for, and give an exp discount when buying levels in, certain Skills &amp; Talents.</i>
<br><br>
<table class="table table-hover table-bordered" style="margin-left: 100px; max-width: 700px;">
	<thead>
		<tr>
			<th style="max-width: 100px;">Source</th>
			<th style="max-width: 250px;">Aptitude</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>Homeworld</td>
			<td id="aptitude_td_world"></td>
		</tr>
	</tbody>
	<tbody>
		<tr>
			<td>Background</td>
			<td id="aptitude_bg"></td>
		</tr>
	</tbody>
	<tbody>
		<tr>
			<td>Amélioration d'élite</td>
			<td id="tr_elite_advance_aptitude"></td>	
		</tr>
	</tbody>
	<tbody>
		<tr>
			<td>Role</td>
			<td id="tr_role_aptitude_1"></td>
			<td id="tr_role_aptitude_1_clash" style="display: none; color: red;">Clash! Take another Stat Aptitude Instead</td>			
		</tr>
	</tbody>	
	<tbody id="tbody_roleaptitudes"></tbody>
</table>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-6">
      &#8195;<h3 style="display: inline">7. Character Stats</h3>&#8195;&#8195;
      <button id="button_reroll" class="btn btn-success btn-sm" style="margin-top: -10px;" disabled="">Re-roll</button>
      &#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;
      &#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;&#8195;
      <button id="button_recalc" disabled="" class="btn btn-warning btn-sm">Re-Calc after Manual Roll Edit</button>
      <br><br>
      &#8195;<label>Starting Base points for Stats:</label>&#8195;&#8195;
      <input id="input_basepoints" class="form-control" style="width: 50px; display: inline" value="20">&#8195;
      <button id="button_applybasepoints" disabled="" class="btn btn-sm btn-primary">Apply + ReCalc</button>
      <br><br>
      <table class="table table-hover table-bordered" style="margin-left: 10px; width: 100%;">
        <thead>
          <tr>
            <th>Stat</th>
            <th>Base</th>
            <th>Roll #1 (1d10)</th>
            <th>Roll #2 (1d10)</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Weapon Skill (WS)</td>
            <td><input id="box_stat_ws_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_ws_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_ws_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_ws_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Ballistic Skill (BS)</td>
            <td><input id="box_stat_bs_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_bs_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_bs_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_bs_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Strength (S)</td>
            <td><input id="box_stat_s_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_s_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_s_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_s_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Toughness (T)</td>
            <td><input id="box_stat_t_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_t_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_t_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_t_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Agility (Ag)</td>
            <td><input id="box_stat_ag_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_ag_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_ag_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_ag_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Intelligence (Int)</td>
            <td><input id="box_stat_int_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_int_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_int_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_int_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Perception (Per)</td>
            <td><input id="box_stat_per_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_per_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_per_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_per_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Willpower (WP)</td>
            <td><input id="box_stat_wp_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_wp_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_wp_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_wp_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Fellowship (Fel)</td>
            <td><input id="box_stat_fel_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_fel_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_fel_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_fel_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Influence (Infl)</td>
            <td><input id="box_stat_infl_base" style="width: 35px;" value="20" disabled=""></td>
            <td><input id="box_stat_infl_roll1" style="width: 35px;"></td>
            <td><input id="box_stat_infl_roll2" style="width: 35px;"></td>
            <td><input id="box_stat_infl_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td>Wounds</td>
            <td><input id="box_stat_wounds_base" style="width: 35px;" value="" disabled=""></td>
            <td><input id="box_stat_wounds_roll1" style="width: 35px;">&#8195;<label>(1d5)</label></td>
            <td></td>
            <td><input id="box_stat_wounds_total" style="width: 35px;" disabled=""></td>
          </tr>
          <tr>
            <td id="fate_title">Fate Points</td>
            <td><input id="box_stat_fate_base" style="width: 35px;" value="" disabled=""></td>
            <td><input id="box_stat_fate_roll1" style="width: 35px;"><label id="fate_result"></label></td>
            <td></td>
            <td><input id="box_stat_fate_total" style="width: 35px;" disabled=""></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="col-md-6">
    &#8195;<h3 style="display: inline">8. Trait Picker</h3>
    <br><br><i>*Traits cannot be purchased directly by spending experience points
and are primarily an aspect that NPCs possess. They might be granted by certain Talents, Elite Advances(e.g Psyker) or by your GM directly (either as a reward/punishment).</i>
    <br><br>
    <table class="table table-hover table-bordered" style="margin-left: 0px;">
      <thead>
        <tr>
          <th>Trait <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
          <th style="width: 30px;"></th>
          <th>Trait <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody_traits">        
      <tr><td id="tr_trait_0" title="Creature is a formless blob, and slow.">Amorphous</td><td><input id="checkbox_trait_0" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_20" title="Creature gains extra attacks.">Multiple Arms</td><td><input id="checkbox_trait_20" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_1" title="Creature can breathe underwater.">Amphibious</td><td><input id="checkbox_trait_1" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_21" title="Gain additional Armour points to all locations.">Natural Armour</td><td><input id="checkbox_trait_21" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_2" title="Always counts as BRACED.">Auto-Stabilised</td><td><input id="checkbox_trait_2" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_22" title="Unarmed attacks deal 1d10+SB damage.">Natural Weapons</td><td><input id="checkbox_trait_22" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_3" title="Creature inflicts Willpower penalty to nearby characters.">Baneful Prescence</td><td><input id="checkbox_trait_3" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_23" title="Switch between incorporeal and corporeal as a Half Action.">Phase</td><td><input id="checkbox_trait_23" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_4" title="Automatically passes Survival skill tests, test Willpower to avoid flight.">Bestial</td><td><input id="checkbox_trait_4" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_24" title="Creature has a psy rating of 1 or more.">Psyker</td><td><input id="checkbox_trait_24" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_5" title="Cannot see.">Blind</td><td><input id="checkbox_trait_5" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_25" title="Movement equals ABx2">Quadruped</td><td><input id="checkbox_trait_25" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_6" title="Deals additional damage on a Charge">Brutal Charge</td><td><input id="checkbox_trait_6" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_26" title="Test Toughness to remove 1 or more damage.">Regeneration</td><td><input id="checkbox_trait_26" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_7" title="Move by digging.">Burrower</td><td><input id="checkbox_trait_7" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_27" title="Avoid Corruption from Psyker elite advance; start at psy rating 2.">Sanctioned</td><td><input id="checkbox_trait_27" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_8" title="No penalties for moving over difficult terrain.">Crawler</td><td><input id="checkbox_trait_8" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_28" title="Determines creature size and benefits.">Size</td><td><input id="checkbox_trait_28" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_9" title="Bonus TB againt normal weapons, immune to disease and poision.">Daemonic</td><td><input id="checkbox_trait_9" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_29" title="Perceive surroundings flawlessly within 30 metres.">Sonar Sense</td><td><input id="checkbox_trait_29" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_10" title="Can see in darkness">Dark Sight</td><td><input id="checkbox_trait_10" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_30" title="Bound to a particular group or creatures in exchange for certain benefits.">Soul Bound</td><td><input id="checkbox_trait_30" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_11" title="Natural weapons are no longer primitive.">Deadly Natural Weapons</td><td><input id="checkbox_trait_11" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_31" title="Failed Willpower test causes creature to flee, trampling anything in its path.">Stampede</td><td><input id="checkbox_trait_31" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_12" title="Forces others to make Fear tests to avoid Shock &amp; Madness.">Fear</td><td><input id="checkbox_trait_12" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_32" title="Become immune to most conditions that would harm normal creatures.">Stuff of Nightmares</td><td><input id="checkbox_trait_32" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_13" title="Fly and enter any altitude.">Flyer</td><td><input id="checkbox_trait_13" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_33" title="+20 bonus to resist grapple, Knock Down and Takedown.">Sturdy</td><td><input id="checkbox_trait_33" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_14" title="Immune to Fear, Pinning, Insanity Points and mind-affecting powers.">From Beyond</td><td><input id="checkbox_trait_14" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_34" title="NPC has Fate points.">Touched by the Fates</td><td><input id="checkbox_trait_34" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_15" title="Fly and enter the Hover altitude.">Hoverer</td><td><input id="checkbox_trait_15" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_35" title="Gain poisonous attack.">Toxic</td><td><input id="checkbox_trait_35" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_16" title="Insubstantial and weightless, cannot be affected by mundane weaponry">Incorporeal</td><td><input id="checkbox_trait_16" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_36" title="The creature is immune to many environmental and natural dangers.">Undying</td><td><input id="checkbox_trait_36" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_17" title="Creature gains immunities and resistances.">Machine</td><td><input id="checkbox_trait_17" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_37" title="Increases one characteristic bonus.">Unnatural Characteristic</td><td><input id="checkbox_trait_37" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_18" title="Character has mechanical augmentation.">Mechanicus Implants</td><td><input id="checkbox_trait_18" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_38" title="Perceive surroundings by uncanny means.">Unnatural Senses</td><td><input id="checkbox_trait_38" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td id="tr_trait_19" title="If not properly controlled, character can become Stunned.">Mind Lock</td><td><input id="checkbox_trait_19" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td><td id="tr_trait_39" title="Creature must deal damage if damaged, or be cast back into the Warp.">Warp Instability</td><td><input id="checkbox_trait_39" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr><tr><td></td><td></td><td id="tr_trait_40" title="Creature&#39;s attacks ignore armour.">Warp Weapons</td><td><input id="checkbox_trait_40" type="checkbox" class="form-control" style="width: 20px; height: 20px;"></td></tr></tbody>
    </table>
    </div>
  </div>
</div>

<br><br>
&#8195;<h3 style="display: inline">9. Skill Picker</h3>&#8195;<i id="skill_prereq">(Select World, Background &amp; Role first)</i>
<br><br>
<div id="div_skillPicker" style="display: none;">
  &#8195;&#8195;<label>Pick a Skill (Skill Aptitudes):</label>&#8195;
  <select id="select_skills" class="form-control" style="width: 350px; display: inline;">
    <option disabled="" selected="">Select a Skill</option>
  </select>
  &#8195;
  <button id="button_addskill" disabled="" class="btn btn-success btn-sm">Add Skill</button>
  <!-- &emsp;** &#10013;<i> - Denotes a Specialist Skill</i> -->
  <br><br>
  &#8195;&#8195;<label>Remaining Exp: </label>&#8195;<input id="input_exp" class="form-control" value="1000" style="display: inline; width: 90px;">&#8195;
  <i>** Experience is shared between Skills, Stat Advances <b>and</b> Talents. Choose wisely!</i>
  <div id="div_noxperror" style="display: none;">
    <h3 style="color: red">&#8195;&#8195;** NOT ENOUGH XP LEFT FOR UPGRADE **</h3>
  </div>
  <br><br>
  <table class="table table-hover table-bordered" style="margin-left: 50px; width: 60%;">
    <thead>
      <tr>
        <th>Skill Name</th>
        <th style="max-width: 150px;"># of Matching Aptitudes</th>
        <th>Known</th>
        <th>Trained</th>
        <th>Experienced</th>
        <th>Expert</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tbody_skills">
    </tbody>
  </table>
</div>
<br><br>
&#8195;<h3 style="display: inline">10. Character Stat Picker</h3>&#8195;<i id="stat_prereq">(Select World, Background &amp; Role first)</i>
<br><br>
<div id="div_statPicker" style="display: none;">
  &#8195;&#8195;<label>Pick a Stat (Stat Aptitudes):</label>&#8195;
  <select id="select_stats" class="form-control" style="width: 300px; display: inline;">
    <option disabled="" selected="">Select a Stat</option>
  </select>
  &#8195;
  <button id="button_addstat" disabled="" class="btn btn-success btn-sm">Add Stat</button>
  <br><br>
  <div id="div_noxperror_stat" style="display: none;">
    <h3 style="color: red">&#8195;&#8195;** NOT ENOUGH XP LEFT FOR UPGRADE **</h3>
  </div>
  <br><br>
  <table class="table table-hover table-bordered" style="margin-left: 50px; width: 60%;">
    <thead>
      <tr>
        <th>Stat Name</th>
        <th style="max-width: 150px;"># of Matching Aptitudes</th>
        <th>Simple</th>
        <th>Intermediate</th>
        <th>Trained</th>
        <th>Proficient</th>
        <th>Expert</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tbody_stats">
    </tbody>
  </table>
</div>
<br><br>
&#8195;<h3 style="display: inline">11. Talent Picker</h3>&#8195;<i style="color: red;">(Work in progress)</i>
<br><br>
<div id="div_talentpicker">
  &#8195;&#8195;<label>Pick a Talent:</label>&#8195;
  <select id="select_talent_1" class="form-control" style="width: 300px; display: inline;">
    <option disabled="" selected="">Select a Talent</option>
  </select>
  &#8195;
  <button id="button_addtalent_1" class="btn btn-success btn-sm">Add Talent</button>
  &#8195;** &#10013;<i> - Denotes a Specialist Talent</i>
  <br><br>
    <div id="div_noxperror_talent" style="display: none;">
    <h3 style="color: red">&#8195;&#8195;** NOT ENOUGH XP LEFT FOR UPGRADE **</h3>
  </div>
  </br></br>
  <table class="table table-hover table-bordered" style="margin-left: 50px; width: 50%;">
    <thead>
      <tr>
        <th>Talent Name</th>        
        <th># of Matching Aptitudes</th>
        <th>Talent Cost</th>
        <th>Prerequisites</th>
        <th>Talent Description</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tbody_talents_1">
    </tbody>
  </table>
</div>
<br><br><br><br>

<!-- DIVINATION Modal -->
<div class="modal fade" id="modal_divination" tabindex="-1" role="dialog" aria-labelledby="modal_divination_Label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="modal_divination_Label">Pick Divination</h4>
      </div>
      <div class="modal-body">
        <select id="select_divination" class="form-control" style="width: 400px;">
          <option disabled="" selected="">Select a Divination</option>
        <option value="0">Mutation Without, Corruption Within</option><option value="1">Trust in your Fear</option><option value="2">Humans must die so that Humanity can endure</option><option value="3">The pain of the bullet is ecstasy compared to damnation</option><option value="4">Be a boon to your allies and the bane of your enemies</option><option value="5">The wise learn from the deaths of others</option><option value="6">Kill the alien before it can speak its lies</option><option value="7">Truth is subjective</option><option value="8">Thought begets Heresy</option><option value="9">Heresy begets Retribution</option><option value="10">A mind without puropse wanders in dark places</option><option value="11">If a job is worth doing it is worth dying for</option><option value="12">Dark dreams lie upon the heart</option><option value="13">Violence solves everything</option><option value="14">Ignorance is a wisdom of its own</option><option value="15">Only the insane have strength enough to prosper</option><option value="16">A suspicious mind is a healthy mind</option><option value="17">Suffering is an unrelenting instructor</option><option value="18">The only true fear is dying without your duty done</option><option value="19">Only in death does duty end</option><option value="20">Innocence is an illusion</option><option value="21">To war is human</option><option value="22">There is no substitute for zeal</option><option value="23">Even one who has nothing can still offer his life</option><option value="24">Do not ask why you serve. Only ask how</option></select>
        <br>
        <label>Description</label>
        <br>
        <textarea id="textarea_div_desc" class="form-control" rows="4"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" style="float: left;">Close</button>
        <button id="button_divination_pick_submit" type="button" class="btn btn-success">Pick</button>
      </div>
    </div>
  </div>
</div>



<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-55665952-1', 'auto');
  ga('send', 'pageview');
</script>

<script type="text/javascript">
var roleAptitudesElementsArray = new Array();
var globalAddedSkillCounter = 0;
var globalAddedStatCounter = 0;
var globalAddedTalentCounter = 0;
var existingRefundCost = 0;
//global status variables
var homeworldSelected = false;
var bgSelected = false;
var roleSelected = false;

$(function() {
/*
  $("#nameError").toggle();
  
  for(var i = 0; i < backgroundArray.length; i++) {
    $("#select_background").append("<option value='"+ i + "'>" + backgroundArray[i] + "</option>");    
  };
*/
  //setup subskillarray
  for(var i = 0; i < skillSubArray.length; i++) {
    skillSubArray[i] = new Array();
  }
  skillSubArray[6] = commonLoreArray;
  skillSubArray[9] = forbiddenLoreArray;
  skillSubArray[13] = linguisticsArray;
  skillSubArray[16] = navigateArray;
  skillSubArray[17] = operateArray;
  skillSubArray[20] = scholasticLoreArray;
  skillSubArray[27] = tradeArray;

  //setup trait table
  for(var i = 0; i < traitArray.length-21; i++) {
    //first part of row
    var s = "<tr><td id=\"tr_trait_" + i + "\" title=\"" + traitArray[i][1] + "\">" + traitArray[i][0] + "</td>";
    s += "<td><input id=\"checkbox_trait_" + i + "\" type=\"checkbox\" class=\"form-control\" style=\"width: 20px; height: 20px;\"/></td>";
    //second part of row
    var j = i+20;
    s += "<td id=\"tr_trait_" + j + "\" title=\"" + traitArray[j][1] + "\">" + traitArray[j][0] + "</td>";
    s += "<td><input id=\"checkbox_trait_" + j + "\" type=\"checkbox\" class=\"form-control\" style=\"width: 20px; height: 20px;\"/></td>";
    s += "</td></tr>";
    $("#tbody_traits").append(s);
  }
  //LAST ROW - ODD one out
  //first part of row
  var s = "<tr><td></td><td></td>";
  //second part of row
  var j = traitArray.length-1;
  s += "<td id=\"tr_trait_" + j + "\" title=\"" + traitArray[j][1] + "\">" + traitArray[j][0] + "</td>";
  s += "<td><input id=\"checkbox_trait_" + j + "\" type=\"checkbox\" class=\"form-control\" style=\"width: 20px; height: 20px;\"/></td>";
  s += "</td></tr>";
  $("#tbody_traits").append(s);

  //setup divination picker
  for(var i = 0; i < divinationArray.length; i++){
    var s = "<option value='" + i + "'>" + divinationArray[i][0];
    s += "</option>";
    $("#select_divination").append(s);
  }
});

$("#select_divination").change(function() {
  var index = parseInt($("#select_divination option:selected").val());
  $("#textarea_div_desc").html(divinationArray[index][1]);
});

$("#select_skills").change(function() {
  $("#button_addskill").attr("disabled", false);
});

$("#select_stats").change(function() {
  $("#button_addstat").attr("disabled", false);
});

$("#button_addskill").on("click", function() {
/*  var index = parseInt($("#select_skills option:selected").val());
  var hasSubSection = false;
  var subSectionIndex = 0;  
  //$("#select_skills option:selected").prop("selected", false);
  if($("#select_skills option:selected").val().split("_").length > 1){
   hasSubSection = true;
   subSectionIndex = parseInt($("#select_skills option:selected").val().split("_")[1]);
  }
  if($("#select_skills").val() != "Select a Skill"){
    $("#select_skills").val("Select a Skill");    
    $("#button_addskill").attr("disabled", true);
    if(hasSubSection){
      $("#select_skills option[value='"+ index + "_" + subSectionIndex + "']").attr("disabled", true);
    }
    else $("#select_skills option[value='"+ index + "']").attr("disabled", true);
  }
  var apt1 = skillArray[index][1];
  var apt2 = skillArray[index][2];
  var numAptMatches = 0;
  //find homeworld aptitude
  var homeworldApt = $("#aptitude_i_world").html();
  var hwAptIndex = 0;
  for(var i = 0; i < aptitudeArray.length; i++) {
    if(aptitudeArray[i] == homeworldApt) hwAptIndex = i;
  }
  homeworldApt = hwAptIndex;
  if((aptitudeArray[homeworldApt] == aptitudeArray[apt1] || aptitudeArray[homeworldApt] == aptitudeArray[apt2]) ||  apt1 == 0) numAptMatches++;
  //find background aptitude
  var bgAptitude = $("#select_bgAptitude").val();
  if((aptitudeArray[bgAptitude] == aptitudeArray[apt1] || aptitudeArray[bgAptitude] == aptitudeArray[apt2]) ||  apt2 == 0) numAptMatches++;
  //find role aptitudes
  //todo
  if((aptitudeArray[bgAptitude] == aptitudeArray[apt1] || aptitudeArray[bgAptitude] == aptitudeArray[apt2]) ||  apt2 == 0) numAptMatches++;
  
  var roleAptitudes = new Array();
  for(var i = 0; i < roleAptitudesElementsArray.length; i++) {
    var elementName = roleAptitudesElementsArray[i];
    var elementValue = $(elementName).html();
    if(elementName.indexOf("select") >= 0) elementValue = $(elementName + " option:selected").val();
    if(elementValue == aptitudeArray[apt1] || elementValue == aptitudeArray[apt2]) numAptMatches++;
  }
  var s = "<tr id=\"tr_skillrow_" + globalAddedSkillCounter + "\">";
  if(hasSubSection) {
    s += "<td id=\"tr_skillrow_" + globalAddedSkillCounter + "_td_name\" data-skillId = '"+index+"_"+subSectionIndex+"'>" + skillArray[index][0] + " - ";
    switch(index) {
      case 6:
        s += commonLoreArray[subSectionIndex];
        break;
      case 9:
        s += forbiddenLoreArray[subSectionIndex];
        break;
      case 13:
        s += linguisticsArray[subSectionIndex];
        break;
      case 16:
        s += navigateArray[subSectionIndex];
        break;
      case 17:
        s += operateArray[subSectionIndex];
        break;
      case 20:
        s += scholasticLoreArray[subSectionIndex];
        break;
      case 25:
        s += tradeArray[subSectionIndex];
        break;
    }
    s += "</td>";
  }
  else s += "<td id=\"tr_skillrow_" + globalAddedSkillCounter + "_td_name\" data-skillId = '"+index+"'>" + skillArray[index][0] + "</td>";
  //calc xp cost for level display
  var xp_Known = calcSkillCost(numAptMatches, "known", false);
  var xp_Trained = calcSkillCost(numAptMatches, "trained", false);
  var xp_Experienced = calcSkillCost(numAptMatches, "experienced", false);
  var xp_Expert = calcSkillCost(numAptMatches, "expert", false);
  //console.log("costs: " + xp_Known + " - " + xp_Trained + " - " + xp_Experienced + " - " + xp_Expert);

  s += "<td id=\"matches_" + globalAddedSkillCounter + "\">" + numAptMatches + "</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_1\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control known\" style=\"display: inline; width: 20px; height: 20px;\" />&emsp;(" + xp_Known +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_2\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control trained\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Trained +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_3\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control experienced\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Experienced +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_4\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control expert\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Expert +"xp)</td>";
  s += "<td><button id=\"button_removeskill_" + globalAddedSkillCounter + "\" class=\"btn btn-xs btn-danger\" data-rowid=\"" + globalAddedSkillCounter + "\" data-xpcost=\"0\" data-optionvalue=\"" + index + "\" data-optionsubvalue=\"" + subSectionIndex + "\">Remove</button</td>";
  s += "</tr>";
  $("#tbody_skills").append(s);
  //append 'known' box script
  var s2 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_1").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "known", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_2").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "known", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_2").attr("disabled", true); HideXPErrorBox(); } });</scrip';
  s2 += 't>';
  $("body").append(s2);
  //append 'trained' box script
  var s3 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_2").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "trained", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_3").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "trained", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_3").attr("disabled", true); HideXPErrorBox(); }  });</scrip';
  s3 += 't>';
  $("body").append(s3);
  //append 'experienced' box script
  var s4 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_3").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "experienced", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_4").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "experienced", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_4").attr("disabled", true); HideXPErrorBox(); }  });</scrip';
  s4 += 't>';
  $("body").append(s4);
  //append 'veteran' box script
  var s5 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_4").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "expert", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); }} else { xpCost = calcSkillCost(numMatches, "expert", true); BuySkill(xpCost, rowId, true); HideXPErrorBox(); }  });</scrip';
  s5 += 't>';
  $("body").append(s5);
  //append remove button script to body
  var removeButtonScript = '<script>$("#button_removeskill_' + globalAddedSkillCounter + '").on("click", function () { var rowId = parseInt($(this).data("rowid")); var cost = parseInt($(this).data("xpcost")); RemoveSkillRow(cost, rowId);  HideXPErrorBox(); RestoreSkill($(this).data("optionvalue"), $(this).data("optionsubvalue"));});</scrip';
  removeButtonScript += 't>';
  $("body").append(removeButtonScript);
  //
  globalAddedSkillCounter++;*/
  
  var currSkill = $.grep(listSkills, function (e) { return e.id === parseInt($("#select_skills option:selected").val()); })[0];
var index = currSkill.id;
  var hasSubSection = false;
  var subSectionIndex = 0;  
  //$("#select_skills option:selected").prop("selected", false);
  if($("#select_skills option:selected").val().split("_").length > 1){
   hasSubSection = true;
   subSectionIndex = parseInt($("#select_skills option:selected").val().split("_")[1]);
  }
  if($("#select_skills").val() != "Select a Skill"){
    $("#select_skills").val("Select a Skill");    
    $("#button_addskill").attr("disabled", true);
    if(hasSubSection){
      $("#select_skills option[value='"+ index + "_" + subSectionIndex + "']").attr("disabled", true);
    }
    else $("#select_skills option[value='"+ index + "']").attr("disabled", true);
  }
  var apt1 = currSkill.apt1;
  var apt2 = currSkill.apt2;
  var numAptMatches = 0;
  //find homeworld aptitude
  var homeworldApt = $("#aptitude_i_world").html();
  var hwAptIndex = 0;
  for(var i = 0; i < aptitudeArray.length; i++) {
    if(aptitudeArray[i] == homeworldApt) hwAptIndex = i;
  }
  homeworldApt = hwAptIndex;
  if((aptitudeArray[homeworldApt] == aptitudeArray[apt1] || aptitudeArray[homeworldApt] == aptitudeArray[apt2]) ||  apt1 == 0) numAptMatches++;
  //find background aptitude
  var bgAptitude = $("#select_bgAptitude").val();
  if((aptitudeArray[bgAptitude] == aptitudeArray[apt1] || aptitudeArray[bgAptitude] == aptitudeArray[apt2]) ||  apt2 == 0) numAptMatches++;
  //find role aptitudes
  //todo
  if((aptitudeArray[bgAptitude] == aptitudeArray[apt1] || aptitudeArray[bgAptitude] == aptitudeArray[apt2]) ||  apt2 == 0) numAptMatches++;
  
  var roleAptitudes = new Array();
  for(var i = 0; i < roleAptitudesElementsArray.length; i++) {
    var elementName = roleAptitudesElementsArray[i];
    var elementValue = $(elementName).html();
    if(elementName.indexOf("select") >= 0) elementValue = $(elementName + " option:selected").val();
    if(elementValue == aptitudeArray[apt1] || elementValue == aptitudeArray[apt2]) numAptMatches++;
  }
  var s = "<tr id=\"tr_skillrow_" + globalAddedSkillCounter + "\">";
  if(hasSubSection) {
    s += "<td id=\"tr_skillrow_" + globalAddedSkillCounter + "_td_name\" data-skillId = '"+index+"_"+subSectionIndex+"'>" + currSkill.name + " - ";
    switch(index) {
      case 6:
        s += commonLoreArray[subSectionIndex];
        break;
      case 9:
        s += forbiddenLoreArray[subSectionIndex];
        break;
      case 13:
        s += linguisticsArray[subSectionIndex];
        break;
      case 16:
        s += navigateArray[subSectionIndex];
        break;
      case 17:
        s += operateArray[subSectionIndex];
        break;
      case 20:
        s += scholasticLoreArray[subSectionIndex];
        break;
      case 25:
        s += tradeArray[subSectionIndex];
        break;
    }
    s += "</td>";
  }
  else s += "<td id=\"tr_skillrow_" + globalAddedSkillCounter + "_td_name\" data-skillId = '"+index+"'>" + currSkill.name + "</td>";
  //calc xp cost for level display
  var xp_Known = calcSkillCost(numAptMatches, "known", false);
  var xp_Trained = calcSkillCost(numAptMatches, "trained", false);
  var xp_Experienced = calcSkillCost(numAptMatches, "experienced", false);
  var xp_Expert = calcSkillCost(numAptMatches, "expert", false);
  //console.log("costs: " + xp_Known + " - " + xp_Trained + " - " + xp_Experienced + " - " + xp_Expert);

  s += "<td id=\"matches_" + globalAddedSkillCounter + "\">" + numAptMatches + "</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_1\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control known\" style=\"display: inline; width: 20px; height: 20px;\" />&emsp;(" + xp_Known +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_2\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control trained\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Trained +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_3\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control experienced\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Experienced +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_4\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control expert\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Expert +"xp)</td>";
  s += "<td><button id=\"button_removeskill_" + globalAddedSkillCounter + "\" class=\"btn btn-xs btn-danger\" data-rowid=\"" + globalAddedSkillCounter + "\" data-xpcost=\"0\" data-optionvalue=\"" + index + "\" data-optionsubvalue=\"" + subSectionIndex + "\">Remove</button</td>";
  s += "</tr>";
  $("#tbody_skills").append(s);
  //append 'known' box script
  var s2 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_1").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "known", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_2").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "known", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_2").attr("disabled", true); HideXPErrorBox(); } });</scrip';
  s2 += 't>';
  $("body").append(s2);
  //append 'trained' box script
  var s3 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_2").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "trained", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_3").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "trained", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_3").attr("disabled", true); HideXPErrorBox(); }  });</scrip';
  s3 += 't>';
  $("body").append(s3);
  //append 'experienced' box script
  var s4 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_3").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "experienced", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_4").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "experienced", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_4").attr("disabled", true); HideXPErrorBox(); }  });</scrip';
  s4 += 't>';
  $("body").append(s4);
  //append 'veteran' box script
  var s5 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_4").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "expert", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); }} else { xpCost = calcSkillCost(numMatches, "expert", true); BuySkill(xpCost, rowId, true); HideXPErrorBox(); }  });</scrip';
  s5 += 't>';
  $("body").append(s5);
  //append remove button script to body
  var removeButtonScript = '<script>$("#button_removeskill_' + globalAddedSkillCounter + '").on("click", function () { var rowId = parseInt($(this).data("rowid")); var cost = parseInt($(this).data("xpcost")); RemoveSkillRow(cost, rowId);  HideXPErrorBox(); RestoreSkill($(this).data("optionvalue"), $(this).data("optionsubvalue"));});</scrip';
  removeButtonScript += 't>';
  $("body").append(removeButtonScript);
  //
  globalAddedSkillCounter++;
});

$("#button_addstat").on("click", function() {
  var index = parseInt($("#select_stats option:selected").val());
  //prevent adding same stat twice
  if($("#select_stats").val() != "Select a Stat"){
    $("#select_stats").val("Select a Stat");    
    $("#button_addstat").attr("disabled", true);
    $("#select_stats option[value='"+ index + "']").attr("disabled", true);
  }
  var apt1 = statLongArray[index][1];
  var apt2 = statLongArray[index][2];
  var numAptMatches = 0;
  //find homeworld aptitude
  var homeworldApt = $("#aptitude_i_world").html();
  var hwAptIndex = 0;
  for(var i = 0; i < aptitudeArray.length; i++) {
    if(aptitudeArray[i] == homeworldApt) hwAptIndex = i;
  }
  homeworldApt = hwAptIndex;
  if((aptitudeArray[homeworldApt] == aptitudeArray[apt1] || aptitudeArray[homeworldApt] == aptitudeArray[apt2]) ||  apt1 == 0) numAptMatches++;
  //find background aptitude
  var bgAptitude = $("#select_bgAptitude").val();
  if((aptitudeArray[bgAptitude] == aptitudeArray[apt1] || aptitudeArray[bgAptitude] == aptitudeArray[apt2]) ||  apt2 == 0) numAptMatches++;
  //find role aptitudes
  var roleAptitudes = new Array();
  for(var i = 0; i < roleAptitudesElementsArray.length; i++) {
    var elementName = roleAptitudesElementsArray[i];
    var elementValue = $(elementName).html();
    if(elementName.indexOf("select") >= 0) elementValue = $(elementName + " option:selected").val();
    if(elementValue == aptitudeArray[apt1] || elementValue == aptitudeArray[apt2]) numAptMatches++;
  }
  var s = "<tr id=\"tr_statrow_" + globalAddedStatCounter + "\">";
  s += "<td id='tr_statrow_" + globalAddedStatCounter + "_td_name' data-statId = '"+index+"'>" + statLongArray[index][0] + "</td>";
  //calc xp cost for level display
  var xp_Simple = calcStatCost(numAptMatches, "simple", false);
  var xp_Intermediate = calcStatCost(numAptMatches, "intermediate", false);
  var xp_Trained = calcStatCost(numAptMatches, "trained", false);
  var xp_Proficient = calcStatCost(numAptMatches, "proficient", false);
  var xp_Expert = calcStatCost(numAptMatches, "expert", false);

  s += "<td id=\"matches_stat_" + globalAddedStatCounter + "\">" + numAptMatches + "</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_1\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" />&emsp;(" + xp_Simple +"xp)</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_2\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Intermediate + "xp)</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_3\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Trained + "xp)</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_4\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Proficient + "xp)</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_5\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Expert + "xp)</td>";
  s += "<td><button id=\"button_removestat_" + globalAddedStatCounter + "\" class=\"btn btn-xs btn-danger\" data-rowid=\"" + globalAddedStatCounter + "\" data-xpcost=\"0\" data-optionvalue=\"" + index + "\">Remove</button</td>";
  s += "</tr>";
  $("#tbody_stats").append(s);
  //append 'simple' box script
  var s2 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_1").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "simple", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); } else { $("#checkbox_stat_' + globalAddedStatCounter + '_2").attr("disabled", false); HideStatXPErrorBox(); }} else { xpCost = calcStatCost(numMatches, "simple", true); BuyStat(xpCost, rowId, true); $("#checkbox_stat_' + globalAddedStatCounter + '_2").attr("disabled", true); HideStatXPErrorBox(); } });</scrip';
  s2 += 't>';
  $("body").append(s2);
  //append 'intermediate' box script
  var s3 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_2").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "intermediate", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); } else { $("#checkbox_stat_' + globalAddedStatCounter + '_3").attr("disabled", false); HideStatXPErrorBox(); }} else { xpCost = calcStatCost(numMatches, "intermediate", true); BuyStat(xpCost, rowId, true); $("#checkbox_stat_' + globalAddedStatCounter + '_3").attr("disabled", true); HideStatXPErrorBox(); } });</scrip';
  s3 += 't>';
  $("body").append(s3);
  //append 'trained' box script
  var s4 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_3").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "trained", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); } else { $("#checkbox_stat_' + globalAddedStatCounter + '_4").attr("disabled", false); HideStatXPErrorBox(); }} else { xpCost = calcStatCost(numMatches, "trained", true); BuyStat(xpCost, rowId, true); $("#checkbox_stat_' + globalAddedStatCounter + '_4").attr("disabled", true); HideStatXPErrorBox(); }  });</scrip';
  s4 += 't>';
  $("body").append(s4);
  //append 'proficient' box script
  var s5 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_4").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "experienced", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); } else { $("#checkbox_stat_' + globalAddedStatCounter + '_5").attr("disabled", false); HideStatXPErrorBox(); }} else { xpCost = calcStatCost(numMatches, "experienced", true); BuyStat(xpCost, rowId, true); $("#checkbox_stat_' + globalAddedStatCounter + '_5").attr("disabled", true); HideStatXPErrorBox(); }  });</scrip';
  s5 += 't>';
  $("body").append(s5);
  //append 'expert' box script
  var s6 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_5").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "expert", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); }} else { xpCost = calcStatCost(numMatches, "expert", true); BuyStat(xpCost, rowId, true); HideStatXPErrorBox(); }  });</scrip';
  s6 += 't>';
  $("body").append(s6);
  //append remove button script to body
  var removeButtonScript = '<script>$("#button_removestat_' + globalAddedStatCounter + '").on("click", function () { var rowId = parseInt($(this).data("rowid")); var cost = parseInt($(this).data("xpcost")); RemoveStatRow(cost, rowId);  HideStatXPErrorBox(); RestoreStat($(this).data("optionvalue"));});</scrip';
  removeButtonScript += 't>';
  $("body").append(removeButtonScript);
  //
  globalAddedStatCounter++;
});

$("#button_addtalent_1").on("click", function() {
	var currTalent = $.grep(listTalents, function (e) { return e.id === parseInt($("#select_talent_1 option:selected").val()); })[0];
	if(currTalent == null) return false;
  var index = parseInt($("#select_talent_1 option:selected").val());
  //prevent adding same stat twice
  if($("#select_talent_1").val() != "Select a Talent"){
    $("#select_talent_1").val("Select a Talent");    
    //$("#button_addtalent_1").attr("disabled", true);
    //$("#select_talent_1 option[value='"+ index + "']").attr("disabled", true);
  }
  var apt1 = currTalent.apt1;
  var apt2 = currTalent.apt2;
  var numAptMatches = 0;
  var roleAptitudes = new Array();
  //find homeworld aptitude
  var homeworldApt = $("#aptitude_i_world").html();
  roleAptitudes.push(homeworldApt);
  var hwAptIndex = 0;
  for(var i = 0; i < aptitudeArray.length; i++) {
    if(aptitudeArray[i] == homeworldApt) hwAptIndex = i;
  }
  homeworldApt = hwAptIndex;
  if((aptitudeArray[homeworldApt] == aptitudeArray[apt1] || aptitudeArray[homeworldApt] == aptitudeArray[apt2]) ||  apt1 == 0) numAptMatches++;
  //find background aptitude
  var bgAptitude = $("#select_bgAptitude").val();
  roleAptitudes.push(aptitudeArray[bgAptitude]);
  if((aptitudeArray[bgAptitude] == aptitudeArray[apt1] || aptitudeArray[bgAptitude] == aptitudeArray[apt2]) ||  apt2 == 0) numAptMatches++;
  //find role aptitudes
  
  for(var i = 0; i < roleAptitudesElementsArray.length; i++) {
    var elementName = roleAptitudesElementsArray[i];
    var elementValue = $(elementName).html();
    if(elementName.indexOf("select") >= 0) elementValue = $(elementName + " option:selected").val();
    if(elementValue == aptitudeArray[apt1] || elementValue == aptitudeArray[apt2]) 
	{		
		numAptMatches++;
	}
	roleAptitudes.push(elementValue);
  }
  //find special role aptitude
  var specialRoleAptitude = $("#select_elite_advance").val();
  //psyker
  if((specialRoleAptitude==1 || specialRoleAptitude == 4) && 
	(aptitudeArray[15] == aptitudeArray[apt1] || aptitudeArray[15] == aptitudeArray[apt2])){
	numAptMatches++;
  }
  //inquisitor
  if((specialRoleAptitude==2) && 
	(aptitudeArray[18] == aptitudeArray[apt1] || aptitudeArray[18] == aptitudeArray[apt2]) && 
	jQuery.inArray( aptitudeArray[18], roleAptitudes )<0){
	numAptMatches++;
  }  
  //soeur de bataille
  if((specialRoleAptitude==5) && 
	(aptitudeArray[8] == aptitudeArray[apt1] || aptitudeArray[8] == aptitudeArray[apt2]) && 
	jQuery.inArray( aptitudeArray[8], roleAptitudes )<0){
	numAptMatches++;
  }  
  
  
  var s = "<tr id=\"tr_talentrow_" + globalAddedTalentCounter + "\">";
  s += "<td id='tr_talentrow_" + globalAddedTalentCounter + "_td_name' data-talentId = '"+index+"'>" + currTalent.name + "</td>";
  //calc xp cost for level display
  var xp_Simple = calcTalentCost(numAptMatches, currTalent.tier, false);

  s += "<td id=\"matches_talent_" + globalAddedTalentCounter + "\">" + numAptMatches + "</td>";
  s += "<td><input id=\"checkbox_talent_" + globalAddedTalentCounter + "_1\" data-talentnum=\"" + globalAddedTalentCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" />&emsp;(" + xp_Simple +"xp)</td>";
  s += "<td>"+currTalent.prerequisites+"</td>";
  s += "<td>"+currTalent.summary+"</td>";
  s += "<td><button id=\"button_removetalent_" + globalAddedTalentCounter + "\" class=\"btn btn-xs btn-danger\" data-rowid=\"" + globalAddedTalentCounter + "\" data-xpcost=\"0\" data-optionvalue=\"" + index + "\">Remove</button</td>";
  s += "</tr>";
  $("#tbody_talents_1").append(s);
  //append 'simple' box script
  var s2 = '<script>$("#checkbox_talent_' + globalAddedTalentCounter + '_1").on("click", function() { var rowId = $(this).data("talentnum"); var numMatches = parseInt($("#matches_talent_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcTalentCost(numMatches, '+currTalent.tier+', false); if(!BuyTalent(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightTalentXPBox(); } else { HideTalentXPErrorBox(); }} else { xpCost = calcTalentCost(numMatches, '+currTalent.tier+', true); BuyTalent(xpCost, rowId, true); HideTalentXPErrorBox(); } });</scrip';
  s2 += 't>';
  $("body").append(s2);
  //append remove button script to body
  var removeButtonScript = '<script>$("#button_removetalent_' + globalAddedTalentCounter + '").on("click", function () { var rowId = parseInt($(this).data("rowid")); var cost = parseInt($(this).data("xpcost")); RemoveTalentRow(cost, rowId);  HideTalentXPErrorBox(); RestoreTalent($(this).data("optionvalue"));});</scrip';
  removeButtonScript += 't>';
  $("body").append(removeButtonScript);
  //
  globalAddedTalentCounter++;  
});

function RemoveSkillRow(cost, rowId){
  adjustExp(-cost);
  $("#tr_skillrow_" + rowId).remove();
}

function RemoveStatRow(cost, rowId){
  adjustExp(-cost);
  $("#tr_statrow_" + rowId).remove();
}

function RemoveTalentRow(cost, rowId){
  adjustExp(-cost);
  $("#tr_talentrow_" + rowId).remove();
}

function BuySkill(cost, rowId, refund){
  if(CanBuy(cost)){
    var existingRefundCost = parseInt($("#button_removeskill_" + rowId).attr("data-xpcost"));
    if(!refund) $("#button_removeskill_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (box ticked)
    else $("#button_removeskill_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (boxes unticked)
    adjustExp(cost);
    return true;
  }
  else return false;
}

function BuyStat(cost, rowId, refund){
  if(CanBuy(cost)){
    var existingRefundCost = parseInt($("#button_removestat_" + rowId).attr("data-xpcost"));
    if(!refund) $("#button_removestat_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (box ticked)
    else $("#button_removestat_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (boxes unticked)
    adjustExp(cost);
    return true;
  }
  else return false;
}

function BuyTalent(cost, rowId, refund){
  if(CanBuy(cost)){
    var existingRefundCost = parseInt($("#button_removetalent_" + rowId).attr("data-xpcost"));
    if(!refund) $("#button_removetalent_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (box ticked)
    else $("#button_removetalent_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (boxes unticked)
    adjustExp(cost);
    return true;
  }
  else return false;
}

function CanBuy(cost){
  var remainingXp = parseInt($("#input_exp").val());
  return ((remainingXp-cost) >= 0)? true:false;
}

function calcSkillCost(numMatches, level, neg){
  var xpCost = 0;
  if(numMatches > 2) numMatches = 2;
  switch(level){
    case "known":
      xpCost = skillAptExpArray[numMatches];
      break;

    case "trained":
      xpCost = skillAptExpArray[numMatches]*2;
      break;

    case "experienced":
      xpCost = skillAptExpArray[numMatches]*3;
      break;

    case "expert":
      xpCost = skillAptExpArray[numMatches]*4;
      break;
  }  
  if(neg) xpCost = -xpCost;  
  return xpCost;
}

function calcStatCost(numMatches, level, neg){
  var xpCost = 0;
  if(numMatches > 2) numMatches = 2;
  switch(level){
    case "simple":
      xpCost = statAptExpArray[numMatches][0];
      break;

    case "intermediate":
      xpCost = statAptExpArray[numMatches][1];
      break;

    case "trained":
      xpCost = statAptExpArray[numMatches][2];
      break;

    case "proficient":
      xpCost = statAptExpArray[numMatches][3];
      break;

    case "expert":
      xpCost = statAptExpArray[numMatches][4];
      break;
  }  
  if(neg) xpCost = -xpCost;  
  return xpCost;
}

function calcTalentCost(numMatches, tier, neg){
   var xpCost = 0;
  if(numMatches > 2) numMatches = 2;
  switch(tier){
    case 1:
      xpCost = talentAptExpArray[numMatches][0];
      break;

    case 2:
      xpCost = talentAptExpArray[numMatches][1];
      break;

    case 3:
      xpCost = talentAptExpArray[numMatches][2];
      break;
  }  
  if(neg) xpCost = -xpCost;  
  return xpCost;
}

function adjustExp(value){
  var currentExp = parseInt($("#input_exp").val());
  var newExp = currentExp - value;
  $("#input_exp").val(newExp);
}

function fillSkillPicker(){
$('#select_skills')
    .empty()
    .append('<option disabled="" selected="">Select a Skill</option>');
	
  //fill skill picker select
  /*for(var i = 0; i < skillArray.length; i++){
    if(i != 6 && i != 9 && i != 13 && i != 16 && i != 17 && i != 20 && i != 27) {
      $("#select_skills").append("<option value=\"" + i + "\" >" + skillArray[i][0] + " (" + aptitudeArray[skillArray[i][1]] + ", " + aptitudeArray[skillArray[i][2]] + ")</option>");
    }
    else {
      var s = "<optgroup label='" + skillArray[i][0] + " (" + aptitudeArray[skillArray[i][1]] + ", " + aptitudeArray[skillArray[i][2]] + ")'>";
      for(var j = 1; j < skillSubArray[i].length; j++) {
        s += "<option value='" + i + "_" + j + "'>" + skillSubArray[i][j] + "</option>";
      }
      s += "</opgroup>";
      $("#select_skills").append(s);
    }
  }*/
  
  listSkills.sort(SortByName);
  $(listSkills).each(function() {
    var i = this.id;
	if(i != 6 && i != 9 && i != 13 && i != 16 && i != 17 && i != 20 && i != 27)
	{
	$("#select_skills").append("<option value=\"" + i + "\" >" + this.name + " (" + aptitudeArray[this.apt1] + ", " + aptitudeArray[this.apt2] + ")</option>");
	}else{
		var s = "<optgroup label='" + this.name + " (" + aptitudeArray[this.apt1] + ", " + aptitudeArray[this.apt2] + ")'>";
		  for(var j = 1; j < this.subSkill.length; j++) {
			s += "<option value='" + this.id + "_" + j + "'>" + this.subSkill[j] + "</option>";
		  }
		  s += "</opgroup>";
		  $("#select_skills").append(s);
	}
  });
}

function fillStatPicker(){
	$('#select_stats')
    .empty()
    .append('<option disabled="" selected="">Select a Stat</option>');
  //fill stat picker select
  for(var i = 0; i < statLongArray.length; i++) {
    $("#select_stats").append("<option value=\"" + i + "\" >" + statLongArray[i][0] + " (" + aptitudeArray[statLongArray[i][1]] + ", " + aptitudeArray[statLongArray[i][2]] + ")</option>");
  }
}

function fillTalentPicker_1(){
  $('#select_talent_1')
    .empty()
    .append('<option disabled="" selected="">Select a Talent</option>');
  //fill tier 1 talent picker select
  /*for(var i = 0; i < talents_tier1_Array.length; i++){
		var colorOption='black';
	  if(talents_tier1_Array[i][1]===TALENT_TIER1)
	  {
		colorOption ="blue"
	  }
	  if(talents_tier1_Array[i][1]===TALENT_TIER2)
	  {
		colorOption ="green"
	  }
      $("#select_talent_1").append("<option value=\"" + i + "\" style=\"color:"+colorOption+"\" title=\""+talents_tier1_Array[i][4]+"\">" + talents_tier1_Array[i][0] +" ("+aptitudeArray[talents_tier1_Array[i][3][0]]+","+aptitudeArray[talents_tier1_Array[i][3][1]]+")</option>");

  }*/
  //TODO: replace by listTalents 
  listTalents.sort(SortByName);
  $(listTalents).each(function() {
	var colorOption='black';
	  if(this.tier===TALENT_TIER1)
	  {
		colorOption ="blue"
	  }
	  if(this.tier===TALENT_TIER2)
	  {
		colorOption ="green"
	  }
	$("#select_talent_1").append("<option value=\"" + this.id + "\" style=\"color:"+colorOption+"\" title=\""+this.summary+"\">" + this.name +" ("+aptitudeArray[this.apt1]+","+aptitudeArray[this.apt2]+")</option>");
	});
}

var statsArray = ["ws", "bs", "s", "t", "ag", "int", "per", "wp", "fel", "infl"];

var skillAptExpArray = [300, 200, 100];
var talentAptExpArray = [
[600, 900, 1200],
[300,450,600],
[200, 300, 400]];
var statAptExpArray = [
[500, 750, 1000, 1500, 2500],
[250, 500, 750, 1000, 1500],
[100, 250, 500, 750, 1250]];

var backgroundArray = [
'Adeptus Administratum', 'Adeptus Arbites', 'Adeptus Astra Telepathica', 
'Adeptus Mechanicus', 'Adeptus Ministorum', 'Imperial Guard', 
'Outcast', 'Adepta Sororitas', 'Mutant', 'Imperial Navy', 'Heretek', 
'Rogue Trader Fleet', 'Exorcised' ];

var backgroundSkillsArray = [
['Commerce OR Medicae', 'Common Lore (Adeptus Administratum)', 'Linguistics (High Gothic)', 'Logic', 'Scholastic Lore (-Pick One-)'],
['Awareness', 'Common Lore (Adeptus Arbites)', 'Common Lore (Underworld)', 'Inquiry OR Interrogation', 'Intimidate', 'Scrutiny'],
['Awareness', 'Common Lore (Adeptus Astra Telepathica)', 'Deceive OR Interrogation', 'Forbidden Lore (The Warp)', 'Psyniscience OR Scrutiny'],
['Awareness OR Operate(-Pick One-)', 'Common Lore (Adeptus Mechanicus)', 'Logic', 'Security', 'Tech Use'],
['Charm', 'Command', 'Common Lore (Adeptus Ministorum)', 'Inquiry OR Scrutiny', 'Linguistics(High Gothic)'],
['Athletics', 'Command', 'Common Lore (Imperial Guard)', 'Medicae OR Operate (Surface)', 'Navigate (surface)'],
['Acrobatics OR Sleight of Hand', 'Common Lore (Underworld)', 'Deceive', 'Dodge', 'Stealth'],
['Athletics', 'Charm OR Intimidate', 'Common Lore (Adepta Sororitas)', 'Linguistics (High Gothic)', 'Medicae OR Parry'],
['Acrobatics OR Athletics', 'Awareness', 'Deceive OR Intimidate', 'Forbidden Lore (Mutants)', 'Survival'],
['Athletics', 'Command or Intimidate', 'Common Lore(Imperial Navy)', 'Navigate (Stellar)', 'Operate (Aeronautica or Voidship)'],
['Deceive or Inquiry', 'Forbidden Lore (pick one)', 'Medicae or Security', 'Tech-Use', 'Trade (pick one)'],
['Charm or Scrutiny', 'Commerce', 'Common Lore(Rogue Traders)', 'Linguistics (pick one alien language)','Operate (Surface or Aeronautica)'],
['Awareness', 'Deceive or Inquiry', 'Dodge', 'Forbidden Lore(Daemonology)', 'Intimidate or Scrutiny']
];

var backgroundTalentsArray = [
['Weapon Training (Las or SP)'],
['Weapon Training (Shock or SP)'],
['Weapon Training (Las)', 'Weapon Training (Low Tech)'],
['Mechadendrite Use (Utility)', 'Weapon Training (SP)'],
['Weapon Training (Low Tech and SP) OR (Flame)'],
['Weapon Training (Las, Low Tech)'],
['Weapon Training (Chain and (Las OR SP))'],
['Weapon Training (Flame or Las, Chain)'],
['Weapon Training (Low-Tech, Solid Projectile)'],
['Weapon Training (Chain or Shock, Solid Projectile)'],
['Weapon Training (Solid Projectile)', 'Mechanicus Implants (see page 137 of the Dark Heresy Core Rulebook)'],
['Weapon Training (Las or Solid Projectile, Shock)'],
['Hatred (Daemons)', 'Weapon Training(Solid Projectile, Chain)', 'An Exorcised character starts with one Malignancy chosen from Table 815: Malignancies (see page 290 of the Dark Heresy Core Rulebook)'],
];

var beackgroundEquipmentArray = [
['Laspistol OR Stub Automatic', 'Imperial Robes', 'Autoquill', 'Chrono', 'Dataslate', 'Medi-kit'],
['Shotgun or Shock Maul', 'Enforcer Light Carapace Armour OR Carapace Chestplate', '3 Doses of Stimm', 'Manacles', '12 Lho Sticks'],
['Laspistol', 'Staff or Whip', 'Light Flakcloak or Flak Vest', 'Micro-Bead or Psy Focus'],
['Autogun or Hand Cannon', 'Monotask Servo-Skull (Utility) or Optical Mechadendrite', 'Imperial Robes', '2 Vials of Sacred Unguents'],
['Hand flamer (or Warhammer and Stub Revolver)', 'Imperial Robes or Rlak Vest', 'Backpack', 'Glow-Globe', 'Monotask Servo-Skull (Laud Hailer)'],
['Lasgun (or Laspistol and Sword)', 'Combat Vest', 'Imperial Guard Flak Armour', 'Grapnel and Line', '12 Lho Sticks', 'Magnoculars'],
['Autopistol or Laspistol', 'Chainsword', 'Armoured Bodyglove or Flak Vest', 'Injector', '2 Doses of Obscura or Slaught'],
['Hand Flamer or Laspistol', 'Chainblade', 'Armoured Bodyglove', 'Chrono', 'Dataslate', 'Stablight', 'Micro-bead'],
['Shotgun (or Stub Revolver and Great Weapon)', 'Grapnel and Line', 'Heavy Leathers', 'Combat Vest', '2 Doses of Stimm'],
['Combat shotgun or hand cannon', 'chainsword or shock whip', 'flak coat', 'rebreather', 'micro-bead'],
['Stub revolver with 2 extra clips of Expander bullets or ManStopper rounds', '1 web grenade', 'combi-tool', 'flak cloak','filtration plugs', '1 dose of de-tox', 'dataslate', 'stablight'],
['Laspistol or autopistol (fitted with Compact weapon upgrade)', 'shock maul', 'mesh cloak or carapace chestplate', 'auspex', 'chrono'],
['Autopistol or stub revolver', 'shotgun', 'chainblade', 'Imperial robes', '3 doses of obscura or tranq','disguise kit or excruciator kit', 'rebreather', 'stablight or glow-globe'],
];

var roleAptitudeArray = [
['Agility', ['Ballistic Skill', 'Weapon Skill'], 'Fieldcraft', 'Finesse', 'Perception'],
['Fieldcraft', 'Intelligence', 'Knowledge', 'Strength', 'Toughness'],
['Agility', 'Ballistic Skill', 'Defence', 'Fellowship', 'Finesse'],
['Fellowship', 'Offence', 'Social', 'Toughness', 'Willpower'],
['Defence', 'Intelligence', 'Knowledge', 'Perception', 'Willpower'],
['Intelligence', 'Knowledge', 'Perception', 'Tech', 'Willpower'],
['Fellowship', 'Intelligence', 'Perception', 'Social', 'Tech'],
['Ballistic Skill', 'Defence', 'Offence', 'Strength', 'Weapon Skill'],
['Leadership', 'Offence', 'Toughness', 'Weapon Skill', 'Willpower'],
['Agility', 'Fieldcraft', 'Intelligence', 'Offence', 'Toughness'],
['Agility', 'Finesse', 'Perception', 'Tech', 'Willpower'],
['Knowledge', 'Offence', 'Strength', 'Toughness', 'Willpower']
];

var roleTalentArray = [
'Jaded OR Leap Up',
'Resistance (-Pick One-) OR Takedown',
'Catfall OR Quick Draw',
'Double Team OR Hatred (-Pick One-)',
'Resistance (Psychic Powers) OR Warp Sense',
'Ambidextrous OR Clues from the Crowds',
'Keen Intuition OR Disarm',
'Iron Jaw OR Rapid Reload',
'Deny the Witch OR Jaded',
'Die Hard or Flagellant',
'Hard Target or Hotshot Pilot',
'Bodyguard or Deny the Witch'
];
/*var aptitudeObj = 	{
						general:{name:"General", value=0},
						weaponSkill:{"Weapon Skill", value=1},
						ballisticSkill:{"Ballistic Skill", value=2},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
						strength:{"Strength", value=3},
					};
aptitudeObj.*/
/*const GENERAL = 0;
const WEAPONSKILL = 1;
const BALLISTICSKILL = 2;
const STRENGTH = 3;
const TOUGHNESS = 4;
const AGILITY = 5;
const INTELLIGENCE = 6;
const PERCEPTION = 7;
const WILLPOWER = 8;
const FELLOWSHIP = 9;
const OFFENCE = 10;
const DEFENCE = 11;
const FINESSE = 12;
const KNOWLEDGE = 13;
const FIELDCRAFT = 14;
const PSYKER = 15;
const SOCIAL = 16;
const TECH = 17;
const LEADERSHIP = 18;

const TALENT_TIER1 = 1;
const TALENT_TIER2 = 2;
const TALENT_TIER3 = 3;*/
var aptitudeArray = [
'General',          //0
'Weapon Skill',
'Ballistic Skill',  //2
'Strength',
'Toughness',        //4
'Agility',
'Intelligence',     //6
'Perception',
'Willpower',        //8
'Fellowship',

'Offence',          //10
'Defence',
'Finesse',          //12
'Knowledge',
'Fieldcraft',       //14
'Psyker',
'Social',           //16
'Tech',
'Leadership',       //18
];

var statLongArray = [
['Weapon Skill', 1, 10],
['Ballistic Skill', 2, 12], //1
['Strength', 3, 10],
['Toughness', 4, 11],       //3
['Agility', 5, 12],
['Intelligence', 6, 13],    //5
['Perception', 7, 14],
['Willpower', 8, 15],       //7
['Fellowship', 9, 16]];

var skillArray = [
['Acrobatie (Acrobatics)', 5, 0,''],
['Athletisme (Athletics)', 3, 0,''],
['Vigilance (Awareness)', 7, 14,''],
['Charme (Charm)', 9, 16,''],
['Commandement (Command)', 9, 18,''],
['Marchandage (Commerce)', 6, 13,''], //5
['Connaissance générale (Common Lore)', 6, 0,''], //6
['Duperie (Deceive)', 9, 16,''],
['Esquive (Dodge)', 5, 11,''],
['Connaissance interdite (Forbidden Lore)', 6, 13,''], //9
['Enquête (Inquiry)', 9, 16,''], //10
['Interrogatoire (Interrogation)', 8, 16,''],
['Intimidation (Intimidate)', 3, 16,''],
['Language (Linguistics)', 6, 0,''], //13
['Logique (Logic)', 6, 13,''],
['Medicae', 6, 14,''],
['Navigation (Navigate)', 6, 14,''], //16
['Pilotage (Operate)', 5, 14,''], //17
['Parade (Parry)', 1, 11,''],
['Psyniscience', 7, 15,''],
['Connaissance Scholastique (Scholastic Lore)', 6, 13,''], //20
['Observation (Scrutiny)', 7, 0,''],
['Sécurité (Security)', 6, 17,''],
['Vol à la tir (Sleight of Hand)', 5, 13,''],
['Discretion (Stealth)', 5, 14,''],
['Survie (Survival)', 7, 14,''], //25
['Technomaitrise (Tech-Use)', 6, 17,''],
['Métier (Trade)', 6, 0,'']]; //27

var skillSubArray = new Array(skillArray.length);

var commonLoreArray = [
'',
'Adepta Sororitas',
'Adeptus Arbites',
'Adeptus Astartes',
'Adeptus Astra Telepathica',
'Adeptus Mechanicus',
'Adetpus Sororitas',
'Askellon Sector',
'Chartist Captains',
'Collegia Titanicus',
'Ecclesiarchy',
'Imperial Creed',
'Imperial Guard',
'Imperial Navy',
'Imperium',
'Navigators',
'Planetary Defence Forces',
'Rogue Traders',
'Schola Progenium',
'Tech',
'Underworld',
'War',
'OTHER',
];

var linguisticsArray = [
'',
'Chapter Runes',
'Chaos Marks',
'Eldar',
'High Gothic',
'Imperial Codes',
'Low Gothic',
'Mercenary Cant',
'Necrontyr',
'Ork',
'Techna-Lingua',
'Tau',
'Underworld',
'Xenos Markings',
'OTHER',
];

var navigateArray = [
'',
'Surface',
'Stellar',
'Warp',
];

var operateArray = [
'',
'Aeronautica',
'Surface',
'Voidship',
];

var scholasticLoreArray = [
'',
'Astromancy',
'Beasts',
'Bureaucracy',
'Chymistry',
'Cryptology',
'Heraldry',
'Imperial Warrants',
'Legend',
'Numerology',
'Occult',
'Philosophy',
'Tactica Imperialis',
'OTHER'];

var tradeArray = [
'',
'Agri',
'Archaeologist',
'Armourer',
'Astographer',
'Chymist',
'Cryptographer',
'Cook',
'Explorator',
'Linguist',
'Loremancer',
'Morticator',
'Performancer',
'Prospector',
'Scrimshawer',
'Sculptor',
'Shipwright',
'Soothsayer',
'Technomat',
'Voidfarer'];

var traitArray = [
  ['Amorphous', 'Creature is a formless blob, and slow.'], //0
  ['Amphibious', 'Creature can breathe underwater.'],
  ['Auto-Stabilised', 'Always counts as BRACED.'],
  ['Baneful Prescence', 'Creature inflicts Willpower penalty to nearby characters.'],
  ['Bestial', 'Automatically passes Survival skill tests, test Willpower to avoid flight.'], //4
  ['Blind', 'Cannot see.'],
  ['Brutal Charge', 'Deals additional damage on a Charge'],
  ['Burrower', 'Move by digging.'],
  ['Crawler', 'No penalties for moving over difficult terrain.'],
  ['Daemonic', 'Bonus TB againt normal weapons, immune to disease and poision.'], //9
  ['Dark Sight', 'Can see in darkness'], //10
  ['Deadly Natural Weapons', 'Natural weapons are no longer primitive.'],
  ['Fear', 'Forces others to make Fear tests to avoid Shock & Madness.'],
  ['Flyer', 'Fly and enter any altitude.'],
  ['From Beyond', 'Immune to Fear, Pinning, Insanity Points and mind-affecting powers.'], //14
  ['Hoverer', 'Fly and enter the Hover altitude.'],
  ['Incorporeal', 'Insubstantial and weightless, cannot be affected by mundane weaponry'],
  ['Machine', 'Creature gains immunities and resistances.'],
  ['Mechanicus Implants', 'Character has mechanical augmentation.'],
  ['Mind Lock', 'If not properly controlled, character can become Stunned.'], //19

  ['Multiple Arms', 'Creature gains extra attacks.'], //20
  ['Natural Armour', 'Gain additional Armour points to all locations.'],
  ['Natural Weapons', 'Unarmed attacks deal 1d10+SB damage.'],
  ['Phase', 'Switch between incorporeal and corporeal as a Half Action.'],
  ['Psyker', 'Creature has a psy rating of 1 or more.'],
  ['Quadruped', 'Movement equals ABx2'],
  ['Regeneration', 'Test Toughness to remove 1 or more damage.'],
  ['Sanctioned', 'Avoid Corruption from Psyker elite advance; start at psy rating 2.'],
  ['Size', 'Determines creature size and benefits.'],
  ['Sonar Sense', 'Perceive surroundings flawlessly within 30 metres.'],
  ['Soul Bound', 'Bound to a particular group or creatures in exchange for certain benefits.'],
  ['Stampede', 'Failed Willpower test causes creature to flee, trampling anything in its path.'],
  ['Stuff of Nightmares', 'Become immune to most conditions that would harm normal creatures.'],
  ['Sturdy', '+20 bonus to resist grapple, Knock Down and Takedown.'],
  ['Touched by the Fates', 'NPC has Fate points.'],
  ['Toxic', 'Gain poisonous attack.'],
  ['Undying', 'The creature is immune to many environmental and natural dangers.'],
  ['Unnatural Characteristic', 'Increases one characteristic bonus.'],
  ['Unnatural Senses', 'Perceive surroundings by uncanny means.'],
  ['Warp Instability', 'Creature must deal damage if damaged, or be cast back into the Warp.'],

  ['Warp Weapons', 'Creature&#39;s attacks ignore armour.'], //40
];

var forbiddenLoreArray = arrayUnique(commonLoreArray.concat(scholasticLoreArray));

var talents_tier1_SubArray = [
]

var characterObj = new Object();

function arrayUnique(array) {
    var a = array.concat();
    for(var i=0; i<a.length; ++i) {
        for(var j=i+1; j<a.length; ++j) {
            if(a[i] === a[j])
                a.splice(j--, 1);
        }
    }
    return a;
};

$("#button_namegenerate").on("click", function(){
  
  if($("#nameError").is(":visible")) {
    $("#nameError").toggle();
  }
	var index = 0;
	
	var male = $("#radio_gender_male").is(":checked");
	var female = $("#radio_gender_female").is(":checked");
	if(male) {
    index = RandomNumberPlz(0, maleNameArray.length);
    $("#box_name").val(maleNameArray[index]);
	}
	else if(female){
    index = RandomNumberPlz(0, femaleNameArray.length);
    $("#box_name").val(femaleNameArray[index]);
	}
	else $("#nameError").toggle();
});
$("#select_elite_advance")
  .change(function(ex, temp) {
	HideEliteXPErrorBox();
		if(existingRefundCost>0){
			var currentExp = parseInt($("#input_exp").val());
			var newExp = currentExp + existingRefundCost;
			$("#input_exp").val(newExp);
		}
	  if($( "#select_elite_advance option:selected" ).data("xp")!=null ){		
		if(!CanBuy( parseInt($( "#select_elite_advance option:selected" ).data("xp")))){
			HighLightEliteXPBox();
		}else{
			var cost = parseInt($( "#select_elite_advance option:selected" ).data("xp"));
			existingRefundCost = parseInt($( "#select_elite_advance option:selected" ).data("xp"));		
			adjustExp(cost);
			HideEliteXPErrorBox();
		}
	  }
	  
	if($( "#select_elite_advance option:selected" ).data("aptitude")==null){
		$("#tr_elite_advance_aptitude").html("");
	}
	else
	{
		$("#tr_elite_advance_aptitude").html(aptitudeArray[$( "#select_elite_advance option:selected" ).data("aptitude")]);
	}
  
  });

$("#select_roles")
  .change(function() {
    $( "#select_roles option:selected" ).each(function() {
      if(parseInt($("#select_bgAptitude option:selected").val()) > 0) {
        if($("#tr_role_aptitude_1_clash").is(":visible")) $("#tr_role_aptitude_1_clash").toggle();      
        $("#tbody_rolebonus").empty();
        $("#tbody_roletalents").empty();      
        var roleIndex = parseInt($(this).val());
        $("#tbody_roleaptitudes").empty();
        var roleIndex = parseInt($(this).val());
        var elementCounter = 0;
        roleAptitudesElementsArray = new Array();
        for(var i = 0; i < roleAptitudeArray[roleIndex].length; i++) {
        	var s = "<tr><td></td><td><i id='role_apt_" + elementCounter + "'>" + roleAptitudeArray[roleIndex][i] + "</i></td>";          
          
          if((roleAptitudeArray[roleIndex][i]) == $("#aptitude_i_world").html() || roleAptitudeArray[roleIndex][i] == aptitudeArray[parseInt($("#select_bgAptitude").val())]) {
            s = s.substring(0, s.length-(28+roleAptitudeArray[roleIndex][i].length));
            s += '<select id="select_role_apt_' + elementCounter + '" name=\"dynamic_select_role\" class=\"form-control\" style=\"color: red; border: 1px solid red; display: inline; width: 200px;\"><option disabled selected>CLASH! Pick a Stat</option>';
            for(var j = 1; j < 10; j++){
              if(aptitudeArray[j] != roleAptitudeArray[roleIndex][i]) {
                s += '<option value="' + aptitudeArray[j] + '" style=\"color: #555;\">' + aptitudeArray[j] + '</option>';
              }
            }
            s += '</select></td>';
            roleAptitudesElementsArray.push("#select_role_apt_" + elementCounter);
        	}
          else if(roleAptitudeArray[roleIndex][i][0].length > 1){
            var fudge = ("<i  id='role_apt_0'>" + "</i></td>").length;
            for(var k = 0; k < roleAptitudeArray[roleIndex][i].length; k++){
              fudge += roleAptitudeArray[roleIndex][i][k].length;
            }
            s = s.substring(0, s.length-(fudge));
            s += '<select id="select_role_apt_' + elementCounter + '" name=\"dynamic_select_role\" class=\"form-control\" style=\"color: red; border: 1px solid red; display: inline; width: 200px;\"><option disabled selected>CHOICE! Pick a Stat</option>';
            for(var j = 0; j < roleAptitudeArray[roleIndex][i].length; j++){
              s += '<option value="' + aptitudeArray[j+1] + '" style=\"color: #555;\">' + aptitudeArray[j+1] + '</option>';
            }
            s += '</select></td>';
            roleAptitudesElementsArray.push("#select_role_apt_" + elementCounter);
          }
          else roleAptitudesElementsArray.push("#role_apt_" + elementCounter);
        	s += "</tr>";       
          $("#tbody_roleaptitudes").append(s);
          var elementName = 'select_role_apt_' + elementCounter;
          var roleAptSelectScript = "<script type=\"text/javascript\">$(\"#" + elementName + "\").change(function() { $(\"#" + elementName + "\").css(\"color\", \"#555\"); $(\"#" + elementName + "\").css(\"border\", \"1px solid green\"); });</scrip";
          roleAptSelectScript += "t>";
          $("body").append(roleAptSelectScript)
          elementCounter++;
        }
      	$("#tbody_roletalents").append("<tr><td><i>" + roleTalentArray[roleIndex] + "</i></td></tr>");
        $("#tbody_rolebonus").append("<tr><td><i title='" + roleBonusArray[roleIndex][1] + "'>" + roleBonusArray[roleIndex][0] + "</i></td></tr>"); 
        roleSelected = true; 
        fillSkillPicker();
        fillStatPicker();
        fillTalentPicker_1();
        if(!$("#div_skillPicker").is(":visible")) {
	         $("#div_skillPicker").toggle();
	         $("#skill_prereq").toggle();
	      }
        if(!$("#div_statPicker").is(":visible")) {
           $("#div_statPicker").toggle();
           $("#stat_prereq").toggle();
        }
      }
      else {
        //$('html, body').animate({
        //  scrollTop: $("#select_bgAptitude").offset().top
        //}, 2000);
        $("#select_bgAptitude").css("border", "1px solid red");
        //alert("Select your background aptitude first.");
        $("#error_bgaptitude").show();
        $("#select_roles>option:eq(0)").attr("selected", true);
      }
    });
});
$("#select_background")
  .change(function() {
    $( "#select_background option:selected" ).each(function() {
      $("#tbody_startingskills").empty();
      $("#tbody_startingtalents").empty();  
      $("#tbody_recroles").empty(); 
      $("#select_roles").empty();
      $("#tbody_startingequip").empty();
      $("#tbody_startingbgbonus").empty();
      $("#aptitude_bg").empty();
      $("#div_bg_aptitude").empty();
      var backgroundIndex = parseInt($(this).val());
      for(var i = 0; i < backgroundSkillsArray[backgroundIndex].length; i++) {
        $("#tbody_startingskills").append("<tr><td><i>" + backgroundSkillsArray[backgroundIndex][i] + "</i></td></tr>");
      }
      for(var i = 0; i < backgroundTalentsArray[backgroundIndex].length; i++) {
        $("#tbody_startingtalents").append("<tr><td><i>" + backgroundTalentsArray[backgroundIndex][i] + "</i></td></tr>");
      }
      var s = '<select id="select_bgAptitude" class="form-control" style="color: red; display: inline; width: 200px;">';
      s += '<option disabled selected>Pick an Aptitude</option>';
      s += '<option value="' + backgroundAptitudesArray[backgroundIndex][0] + '" style=\"color: #555;\">' + aptitudeArray[backgroundAptitudesArray[backgroundIndex][0]] + '</option>';
      s += '<option value="' + backgroundAptitudesArray[backgroundIndex][1] + '" style=\"color: #555;\">' + aptitudeArray[backgroundAptitudesArray[backgroundIndex][1]] + '</option>';
      s += '</select>';
      //$("#aptitude_bg").append(s);
      $("#div_bg_aptitude").append(s);
      $("#div_bg_aptitude").append("&emsp;<b id=\"error_bgaptitude\" style=\"display: none; color: red;\">Select your background aptitude first!</b>");

      var bgAptSelectScript = "<script type=\"text/javascript\">$(\"#select_bgAptitude\").change(function() { $(\"#select_bgAptitude\").css(\"color\", \"#555\"); $(\"#select_bgAptitude\").css(\"border\", \"1px solid green\"); $(\"#error_bgaptitude\").hide(); $(\"#aptitude_bg\").empty(); $(\"#aptitude_bg\").html(\"<i id='aptitude_i_bg'>\" +" + "aptitudeArray[$(\"#select_bgAptitude option:selected\").val()] + " + "\"</i>\"); });</scrip";
      bgAptSelectScript += "t>";
      $("body").append(bgAptSelectScript)
      
      $("#select_roles").append("<option disabled selected>Select Role</option>");
      for(var i = 0; i < rolesListArray.length; i++) {
        var recommended = false;
        for(var j = 0; j < backgroundRecRolesIndexArray[backgroundIndex].length; j++) {
          if(backgroundRecRolesIndexArray[backgroundIndex][j] == i) recommended = true;
        }
        if(recommended) $("#select_roles").append("<option value='" + i + "'>" + rolesListArray[i] + " **</option>");
        else $("#select_roles").append("<option value='" + i + "'>" + rolesListArray[i] + "</option>");
      }
      for(var i = 0; i < beackgroundEquipmentArray[backgroundIndex].length; i++) {
        $("#tbody_startingequip").append("<tr><td><i>" + beackgroundEquipmentArray[backgroundIndex][i] + "</i></td></tr>");
      }
      $("#tbody_startingbgbonus").append("<tr><td><i title='" + backgroundBonusArray[backgroundIndex][1] + "'>" + backgroundBonusArray[backgroundIndex][0] + "</i></td></tr>");
      bgSelected = true;
    });
});

var firstWorldSelect = true;

$("#select_world")
  .change(function() {
    $( "#select_world option:selected" ).each(function() {
      if($("#button_reroll").is(":disabled")){
        $("#button_reroll").attr("disabled", false);
      }
      if($("#button_recalc").is(":disabled")){
        $("#button_recalc").attr("disabled", false);
      }
      if($("#button_applybasepoints").is(":disabled")){
        $("#button_applybasepoints").attr("disabled", false);
      }      
      var worldType = $(this).val();
      resetBgColours();
      rollStats(worldType);
      if(firstWorldSelect) {
	      //generate + apply divination
		  $("#tbody_divination").empty();
		  RollDivination();
		  firstWorldSelect = false;
		  $("#button_divination_reroll").attr("disabled", false);
      $("#button_divination_pick").attr("disabled", false);
	  }
      $("#tbody_startingworldbonus").empty();
      $("#tbody_startingworldbonus").append("<tr><td><i title='" + homeworldBonusArray[parseInt(worldType)][1] + "'>" + homeworldBonusArray[parseInt(worldType)][0] + "</i></td></tr>");
      homeworldSelected = true;
    });
});
  
$("#button_reroll").on("click", function(){
  var worldType = $("#select_world option:selected").val();  
  rollStats(worldType);
});

$("#button_divination_reroll").on("click", function() {
	//generate + apply divination
	$("#tbody_divination").empty();
	RollDivination();
});

$("#button_recalc").on("click", function() {
	ReCalcStats();
});

$("#button_applybasepoints").on("click", function() {
  var basePoints = $("#input_basepoints").val();
  for(var i = 0; i < statsArray.length; i++) {
    $("#box_stat_" + statsArray[i] + "_base").val(basePoints);
  }
  ReCalcStats();
});

function HighLightXPBox(){
  $("#input_exp").css("border", "1px solid red");
  $("#div_noxperror").show();
}

function HideXPErrorBox(){
  $("#input_exp").css("border", "1px solid #ccc");
  $("#div_noxperror").hide();
  $("#div_noxperror_stat").hide();
}

function HighLightStatXPBox(){
  $("#input_exp").css("border", "1px solid red");
  $("#div_noxperror_stat").show();
}

function HideStatXPErrorBox(){
  $("#input_exp").css("border", "1px solid #ccc");
  $("#div_noxperror").hide();
  $("#div_noxperror_stat").hide();
  $("#div_noxperror_talent").hide();
}

function HideTalentXPErrorBox(){
  $("#input_exp").css("border", "1px solid #ccc");
  $("#div_noxperror").hide();
  $("#div_noxperror_talent").hide();
}

function HighLightTalentXPBox(){
  $("#input_exp").css("border", "1px solid red");
  $("#div_noxperror_talent").show();
}

function HighLightEliteXPBox(){
  $("#input_exp").css("border", "1px solid red");
  $("#div_noxpeliteerror").show();
}

function HideEliteXPErrorBox(){
  $("#input_exp").css("border", "1px solid #ccc");
  $("#div_noxpeliteerror").hide();
}

function RestoreSkill(index, subIndex){
  var hasSubSection = false;
  if(subIndex > 0) hasSubSection = true;
  if(hasSubSection){
    $("#select_skills option[value='" + index + "_" + subIndex + "']").attr("disabled", false);
  }
  else $("#select_skills option[value='" + index + "']").attr("disabled", false);
}

function RestoreStat(index){
  $("#select_stats option[value='" + index + "']").attr("disabled", false);
}

function RestoreTalent(index){
  $("#select_talent_1 option[value='" + index + "']").attr("disabled", false);
}

$("#button_divination_pick").on("click", function() {
  $("#modal_divination").modal("show");
});

$("#button_divination_pick_submit").on("click", function() {
  if($("#select_divination option:selected").val() != "-1"){
    var oldDivIndex = parseInt($("#td_divination").data("div_index"));
    if(oldDivIndex == divinationArray.length-1) {
      var value = parseInt($("#box_stat_fate_base").val());
      $("#box_stat_fate_base").val(value-1);
      ReCalcStats();
    }
    var index = parseInt($("#select_divination option:selected").val());
    $("#tbody_divination").empty();
    $("#tbody_divination").append("<tr><td id=\"td_divination\" data-div_index=\"" + index + "\"><i title='" + divinationArray[index][1] + "'>" + divinationArray[index][0] + "</i></td></tr>");
    if(index == divinationArray.length-1) {
      var value = parseInt($("#box_stat_fate_base").val());
      $("#box_stat_fate_base").val(value+1);
      ReCalcStats();
    }
    $("#modal_divination").modal("hide");
  }
});
/////////////////////////////////
//GET IMAGE FUNCTIONS FOR jsPDF //
/////////////////////////////////
var getImageFromUrl = function(url, callback) {
  var img = new Image, data, ret={data: null, pending: true};
  
  img.onError = function() {
    throw new Error('Cannot load image: "'+url+'"');
  }
  img.onload = function() {
    var canvas = document.createElement('canvas');
    document.body.appendChild(canvas);
    canvas.width = img.width;
    canvas.height = img.height;

    var ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    // Grab the image as a jpeg encoded in base64, but only the data
    data = canvas.toDataURL('image/jpeg').slice('data:image/jpeg;base64,'.length);
    
    // Convert the data to binary form
    data = atob(data)
    document.body.removeChild(canvas);

    ret['data'] = data;
    ret['pending'] = false;
    if (typeof callback === 'function') {
      callback(data);
    }
  }
  img.src = url;

  return ret;
}
	//////////////////////////////////
	//////////////////////////////////

	var doc = new jsPDF();
	var marginTop = 14;
	var marginLeft = 14;
	var lineSpacing = 5;
	var underlineWidth = 0.25;

	$("#button_testpdf").on("click", function(){
		doc = new jsPDF(); //reset doc
		doc.setFontSize(12);
		doc.setLineWidth(underlineWidth);

	///////////////////////////////////////////////////
	// Add field names in standard text & underlines //
	///////////////////////////////////////////////////
	//character name
	//doc.text(marginLeft, marginTop, 'Character Name:');  
	//doc.line(marginLeft+35, (marginTop+1), 95, (marginTop+1));
	//homeworld
	//doc.text(marginLeft, marginTop+lineSpacing, 'Homeworld:');
	//doc.line(marginLeft+25, (marginTop+1)+lineSpacing, 95, (marginTop+1)+lineSpacing);
	//background

	//role

  
  getImageFromUrl('http://heresycreator.96.lt/pcsheet1-200ppi.jpg', AddPCSheetImg);
	// if($("#radio_print_sheet").prop("checked")) getImageFromUrl('http://heresycreator.96.lt/pcsheet1-200ppi.jpg', AddPCSheetImg);
	// else getImageFromUrl('http://heresycreator.96.lt/DH-icon.jpeg', AddImage);  
  
})

function AddImage(imgData){
  doc.addImage(imgData, 'JPEG', 95, 10, 35, 60); 
  doc.output("dataurlnewwindow");
}

function AddPCSheetImg(imgData){
	var w = 210;
	var h = 300;
	doc.addImage(imgData, 'JPEG', 0, 0, w, h);	

	AddFieldText();
}

var yPos_stat2 = 0;

function AddFieldText(){
	////////////////////////////////////////
	// Add field values in 'Times' italic //
	////////////////////////////////////////
	doc.setFont("times");
	doc.setFontType("italic");
	//character name  
	doc.text(marginLeft+26, marginTop, $("#box_name").val())
	//homeworld
	if($("#select_world").val() != null) doc.text(marginLeft+20, marginTop+lineSpacing, $("#select_world option:selected").html().split("(")[0]);
	//background
	if($("#select_background").val() != null) doc.text(marginLeft+19, marginTop+(lineSpacing*2), $("#select_background option:selected").html());
	//role
	if($("#select_roles").val() != null) doc.text(marginLeft+9, marginTop+(lineSpacing*3), $("#select_roles option:selected").html().split("*")[0]);
	//elite advances
	
	//divination
	if($("#td_divination i").html() != null) doc.text(marginLeft+16, marginTop+(lineSpacing*5), $("#td_divination i").html());	
	//notes

  //Draw Gender
  if($("#radio_gender_male").prop("checked")) doc.text(137, marginTop+(lineSpacing), "Male");
  else doc.text(137, marginTop+(lineSpacing), "Female");

  //CHARACTER STATS
  if(roleSelected){
    doc.setFontSize(30);
    //doc.setFont("courier");
    doc.setFontType("normal");
    //Weapon Skill
    var digit1 = Math.floor(parseInt($("#box_stat_ws_total").val())/10);
    var digit2 = parseInt($("#box_stat_ws_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*12.5), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*12.5), digit2.toString());
    //Intelligence
    digit1 = Math.floor(parseInt($("#box_stat_int_total").val())/10);
    digit2 = parseInt($("#box_stat_int_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*12.5), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*12.5), digit2.toString());

    //Ballistic Skill
    digit1 = Math.floor(parseInt($("#box_stat_bs_total").val())/10);
    digit2 = parseInt($("#box_stat_bs_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*16.1), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*16.1), digit2.toString());
    //Perception
    digit1 = Math.floor(parseInt($("#box_stat_per_total").val())/10);
    digit2 = parseInt($("#box_stat_per_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*16.1), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*16.1), digit2.toString());

    //Strength
    digit1 = Math.floor(parseInt($("#box_stat_s_total").val())/10);
    digit2 = parseInt($("#box_stat_s_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*19.8), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*19.8), digit2.toString());
    //Willpower
    digit1 = Math.floor(parseInt($("#box_stat_wp_total").val())/10);
    digit2 = parseInt($("#box_stat_wp_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*19.8), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*19.8), digit2.toString());

    //Toughness
    digit1 = Math.floor(parseInt($("#box_stat_t_total").val())/10);
    digit2 = parseInt($("#box_stat_t_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*23.2), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*23.2), digit2.toString());
    //Fellowship
    digit1 = Math.floor(parseInt($("#box_stat_fel_total").val())/10);
    digit2 = parseInt($("#box_stat_fel_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*23.2), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*23.2), digit2.toString());

    //Agility
    digit1 = Math.floor(parseInt($("#box_stat_ag_total").val())/10);
    digit2 = parseInt($("#box_stat_ag_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*26.8), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*26.8), digit2.toString());
    //Influence
    digit1 = Math.floor(parseInt($("#box_stat_infl_total").val())/10);
    digit2 = parseInt($("#box_stat_infl_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*26.8), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*26.8), digit2.toString());
  }

  //APTITUDES
  doc.setFontSize(12);
  doc.setFont("times");
  doc.setFontType("italic");
  if(homeworldSelected){
    doc.text(marginLeft, marginTop+(lineSpacing*50.5), $("#aptitude_i_world").html());
  }
  if(bgSelected){
    doc.text(marginLeft, marginTop+(lineSpacing*51.4), $("#aptitude_i_bg").html());
  }
  if(roleSelected){
    var spacingVal = 0.9;

    for(var i = 0; i < 5; i++){
      var offset = (i + 2);
      if(i < 4) var xOffset = 0;
      else {
        xOffset = 43;
        spacingVal = 0;
      }
      if($("#role_apt_" + i).val() != null){
        doc.text(marginLeft+xOffset, marginTop+(lineSpacing*(50.5+(offset*spacingVal))), $("#role_apt_" + i).html());
      }
      else{
        if($("#select_role_apt_" + i +" option:selected").val() != "CHOICE! Pick a Stat" || $("#select_role_apt_" + i +" option:selected").val() != "CLASH! Pick a Stat"){
          doc.text(marginLeft+xOffset, marginTop+(lineSpacing*(50.5+(offset*spacingVal))), $("#select_role_apt_" + i +" option:selected").val());
        }
      }
    }
  }

  ///////////////////////
  // DRAW SKILL LEVELS //
  ///////////////////////
  var sqW = 2;
  doc.setDrawColor(0);
  doc.setFillColor(0);
  var subSkillCounter = 0;
  var forbiddenSkillCounter = 0;
  var linguisticsSkillCounter = 0;
  var scholasticSkillCounter = 0;
  var tradeSkillCounter = 0;
  var doNotDraw = false;

  $("#tbody_skills tr").each( function(){ 
    doNotDraw = false;
    var n = $(this).attr("id");
    var rowId = n.split("_")[2];
    var skill = $("#" + n + "_td_name").html();
    var subSkill = skill.split("-");
    var subSkillParent = subSkill[0];
    
    var parentName = subSkillParent.split(" ");
    var actualParentName = parentName[0];
    for(var i = 1; i < parentName.length; i++){
      if(parentName[i] != "" && parentName[i] != " "){
        actualParentName += " ";
        actualParentName += parentName[i];
      }
    }

    var isSubSkill = false;    
    if(subSkill.length > 1){
      switch(actualParentName){
        case "Common Lore":
          if(subSkillCounter < 4) {
            isSubSkill = true;
            subSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Forbidden Lore":
          if(forbiddenSkillCounter < 4) {
            isSubSkill = true;
            forbiddenSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Linguistics":
          if(linguisticsSkillCounter < 2) {
            isSubSkill = true;
            linguisticsSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Scholastic Lore":
          if(scholasticSkillCounter < 5) {
            isSubSkill = true;
            scholasticSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Trade":
          if(tradeSkillCounter < 3) {
            isSubSkill = true;
            tradeSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Navigate":
          isSubSkill = true;
          subSkill = subSkill[1].slice(1);
          break;
        case "Operate":
          isSubSkill = true;
          subSkill = subSkill[1].slice(1);
          break;
      }
      if(isSubSkill == false) doNotDraw = true;
      
    }
    else if(subSkill.length > 1) doNotDraw = true;
    
    var yPos = 0;
    var xSkillOffset = 48;
    var rightColumn = false;
    var rightColumnLower = false;
    var additionalFudge = 0;
    
    var xPos_Known = 134.4;
    var xPos_Trained = 139;
    var xPos_Exp = 143.6;
    var xPos_Expert = 148.2;

    switch(skill) {
      case "Acrobatics":
        yPos = marginTop+60.7;
        break;
      case "Athletics":
        yPos = marginTop+65.5;
        break;
      case "Awareness":
        yPos = marginTop+70.4;
        break;
      case "Charm":
        yPos = marginTop+75.3;
        break;
      case "Command":
        yPos = marginTop+80.1;
        break;
      case "Commerce":
        yPos = marginTop+84.9;
        break;
      case "Deceive":
        yPos = marginTop+113.5;
        break;
      //Common Lore
      case "Dodge":
        yPos = marginTop+118.5;
        break;
      //Forbidden Lore
      case "Inquiry":
        yPos = marginTop+147.7;
        break;
      case "Interrogation":
        yPos = marginTop+152.6;
        break;
      case "Intimidate":
        yPos = marginTop+157.5;
        break;
      //Linguistics
      case "Logic":
        yPos = marginTop+176.2;
        break;

      //2nd Column
      //
      case "Medicae":
        rightColumn = true;
        yPos = marginTop+60.8;
        break;
      //Navigate!
      //Operate!
      case "Parry":
        rightColumn = true;
        yPos = marginTop+94.8;
        break;
      case "Psyniscience":
        rightColumn = true;
        yPos = marginTop+99.6;
        break;
      //Scholastic Lore
      case "Scrutiny":
        yPos = marginTop+133.2;
        rightColumnLower = true;
        break;
      case "Security":
        yPos = marginTop+138.0;
        rightColumnLower = true;
        break;
      case "Sleight of Hand":
        yPos = marginTop+142.9;
        rightColumnLower = true;
        break;
      case "Stealth":
        yPos = marginTop+147.77;
        rightColumnLower = true;
        break;
      case "Survival":
        yPos = marginTop+152.6;
        rightColumnLower = true;
        break;
      case "Tech-Use":
        yPos = marginTop+156.95;
        rightColumnLower = true;
        additionalFudge = -0.2;
        break;
      //Trade
    }

    if(rightColumn) {
      xPos_Known = 134.75+xSkillOffset;
      xPos_Trained = 138.95+xSkillOffset;
      xPos_Exp = 143.3+xSkillOffset;
      xPos_Expert = 147.8+xSkillOffset;
    }
    if(rightColumnLower) {
      xPos_Known = 134.2+xSkillOffset+additionalFudge;
      xPos_Trained = 138.94+xSkillOffset+additionalFudge;
      xPos_Exp = 143.5+xSkillOffset+additionalFudge;
      xPos_Expert = 148.3+xSkillOffset+additionalFudge;
    } 

    if(isSubSkill){  
      var subSkillNameXPos = 108.5;
      var subSkillNameYPos = 0;
      switch(actualParentName){
        case "Common Lore":
          if(subSkillCounter == 1) yPos = marginTop+89.8+(4.9*subSkillCounter);          
          else yPos = marginTop+89.8+(4.9*subSkillCounter)+(-0.04*subSkillCounter);
          subSkillNameYPos = (lineSpacing*subSkillCounter); //for title printing
          break;
        case "Forbidden Lore":
          if(forbiddenSkillCounter == 1) yPos = marginTop+123.29+(4.9*forbiddenSkillCounter);
          else yPos = marginTop+123.29+(4.9*forbiddenSkillCounter)+(-0.04*forbiddenSkillCounter);
          subSkillNameYPos = (lineSpacing*forbiddenSkillCounter)+33.5; //for title printing
          break;
        case "Linguistics":
          break;
        case "Navigate":
          rightColumn = true;
          if(subSkill == "Surface");
          if(subSkill == "Stellar");
          if(subSkill == "Warp");
          break;
        case "Operate":
          if(subSkill == "Aeronautica");
          if(subSkill == "Stellar");
          if(subSkill == "Voidship");
          break;
        case "Scholastic Lore":
          rightColumnLower = true;
          subSkillNameXPos = 158.5;
          break;
        case "Trade":
          rightColumnLower = true;
          subSkillNameXPos = 158.5;
          break;
      }

      if(rightColumn) {
      xPos_Known = 134.75+xSkillOffset;
      xPos_Trained = 138.95+xSkillOffset;
      xPos_Exp = 143.3+xSkillOffset;
      xPos_Expert = 147.8+xSkillOffset;
      }
      if(rightColumnLower) {
        xPos_Known = 134.2+xSkillOffset+additionalFudge;
        xPos_Trained = 138.94+xSkillOffset+additionalFudge;
        xPos_Exp = 143.5+xSkillOffset+additionalFudge;
        xPos_Expert = 148.3+xSkillOffset+additionalFudge;
      }
    }
    if(HasSkillKnown(rowId) && doNotDraw == false){
      if(isSubSkill) {
        doc.setFontSize(8);
        doc.text(subSkillNameXPos, marginTop+92+subSkillNameYPos, subSkill);
      }
      doc.rect(xPos_Known, yPos, sqW, sqW, 'F');
      if(HasSkillTrained(rowId)){
        doc.rect(xPos_Trained, yPos, sqW, sqW, 'F');
        if(HasSkillExperienced(rowId)){
          doc.rect(xPos_Exp, yPos, sqW, sqW, 'F');
          if(HasSkillExpert(rowId)){
          doc.rect(xPos_Expert, yPos, sqW, sqW, 'F');
          }
        }
      }
    }
  });

  //draw attribute levels
  $("#tbody_stats tr").each( function(){
    var n = $(this).attr("id");
    var rowId = n.split("_")[2];
    var stat = $("#" + n + "_td_name").html();

    var yPos_stat = 0;
    var xPos = 0;
    var circle_gap = 2.4;
    var stat_gap = 18.15;
    
    var xPos_basic_left = 47.45;
    var xPos_basic_right = 59.85;

    doc.setFillColor(0, 0, 0);
    switch(stat) {
      case "Weapon Skill":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 69.8;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 72.2;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 74.6;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 77;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 69.8;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Ballistic Skill":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 87.65;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 90.05;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 92.45;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 94.85;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 87.65;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Strength":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 87.65 + stat_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 90.05 + stat_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 92.45 + stat_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 94.85 + stat_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 87.65 + stat_gap;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Toughness":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 123.36;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 123.36 + circle_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 123.36 + circle_gap*2;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 123.36 + circle_gap*3;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 123.36;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Agility":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 141.16;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 141.16 + circle_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 141.16 + circle_gap*2;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 141.16 + circle_gap*3;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 141.16;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      //////////////////////
      //// RIGHT COLUMN ////
      //////////////////////
      case "Intelligence":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 69.8;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 72.25;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 74.65;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 77.05;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 69.8;
          doc.ellipse(xPos_basic_right-1.8, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Perception":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 87.65;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 90.05;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 92.5;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 94.9;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 87.65;
          doc.ellipse(xPos_basic_right-1.8, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Willpower":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 87.65 + stat_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 90.05 + stat_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 92.5 + stat_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 94.9 + stat_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 87.65 + stat_gap;
          doc.ellipse(xPos_basic_right-1.8, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Fellowship":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 123.36;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 123.36 + circle_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 123.41 + circle_gap*2;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 123.41 + circle_gap*3;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 123.36;
          doc.ellipse(xPos_basic_right-1.8, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
    }

  });

  CompleteDocument();
}

function CompleteDocument(){
	doc.output("dataurlnewwindow");
}

//skill checkbox test methods
function HasSkillKnown(rowId){
  return $("#checkbox_" + rowId + "_1").prop("checked");
}

function HasSkillTrained(rowId){
  return $("#checkbox_" + rowId + "_2").prop("checked");
}

function HasSkillExperienced(rowId){
  return $("#checkbox_" + rowId + "_3").prop("checked");
}

function HasSkillExpert(rowId){
  return $("#checkbox_" + rowId + "_4").prop("checked");
}

/** import csv function*/
function handleFiles(files) {
      // Check for the various File API support.
      if (window.FileReader) {
          // FileReader are supported.
          getAsText(files[0]);
      } else {
          alert('FileReader are not supported in this browser.');
      }
    }

    function getAsText(fileToRead) {
      var reader = new FileReader();
      // Read file into memory as UTF-8      
      reader.readAsText(fileToRead);
      // Handle errors load
      reader.onload = loadHandler;
      reader.onerror = errorHandler;
    }

    function loadHandler(event) {
      var csv = event.target.result;
      processData(csv);
    }

    function processData(csv) {
        var allTextLines = csv.split(/\r\n|\n/);
        var lines = [];
        for (var i=0; i<allTextLines.length; i++) {
            var data = allTextLines[i].split(';');
                var tarr = [];
                for (var j=0; j<data.length; j++) {
                    tarr.push(data[j]);
                }
                lines.push(tarr);
        }
      characterObj = JSON.parse(lines[0][0]);
	  LoadCharacterData(characterObj);
    }

    function errorHandler(evt) {
      if(evt.target.error.name == "NotReadableError") {
          alert("Canno't read file !");
      }
    }
/** End import csv function*/
$("#button_load").on("click", function(){
	raz();
	var characterObj = JSON.parse(localStorage.getItem('save_pj'));
	LoadCharacterData(characterObj);
});

$("#button_save").on("click", function(){ExportCharacter(true);});
$("#button_export").on("click", function(){ExportCharacter();});


function ExportCharacter(isSave)
{
	var data = new Object();
	data.id = 0;
	data.gender = 'M';
	if($('#radio_gender_female').is(':checked'))data.gender = 'F';
	data.name = $('#box_name').val();
	data.homeworld = $('#select_world').val();
	data.background = $('#select_background').val(); 
	data.bg_aptitude = $('#select_bgAptitude').val(); 
	data.role = $('#select_roles').val(); 	
	data.elite_aptitude = $('#select_elite_advance').val(); 	
	
	data.base_stat_points = $('#input_basepoints').val(); 
	data.stat_ws_1 = $("#box_stat_ws_roll1").val();
    data.stat_ws_2 = $("#box_stat_ws_roll2").val();
    data.stat_bs_1 = $("#box_stat_bs_roll1").val();
    data.stat_bs_2 = $("#box_stat_bs_roll2").val();
    data.stat_s_1 = $("#box_stat_s_roll1").val();
    data.stat_s_2 = $("#box_stat_s_roll2").val();
    data.stat_t_1 = $("#box_stat_t_roll1").val();
    data.stat_t_2 = $("#box_stat_t_roll2").val();
    data.stat_ag_1 = $("#box_stat_ag_roll1").val();
    data.stat_ag_2 = $("#box_stat_ag_roll2").val();
    data.stat_int_1 = $("#box_stat_int_roll1").val();
    data.stat_int_2 = $("#box_stat_int_roll2").val();
    data.stat_per_1 = $("#box_stat_per_roll1").val();
    data.stat_per_2 = $("#box_stat_per_roll2").val();
    data.stat_wil_1 = $("#box_stat_wp_roll1").val();
    data.stat_wil_2 = $("#box_stat_wp_roll2").val();
    data.stat_fel_1 = $("#box_stat_fel_roll1").val();
    data.stat_fel_2 = $("#box_stat_fel_roll2").val();
    data.stat_infl_1 = $("#box_stat_infl_roll1").val();
    data.stat_infl_2 = $("#box_stat_infl_roll2").val();
    data.stat_wounds = $("#box_stat_wounds_roll1").val();
    data.stat_fatepoints = $("#box_stat_fate_roll1").val();
	data.divination = new Object();
	data.divination.id = $('#td_divination').data("div_index");
	data.divination.title = $('#td_divination i').prop("title");
	data.divination.description = $('#td_divination i').html();
	data.roleAptitudesElements = new Array();
	data.trait = new Array();
	for(var i = 0; i < roleAptitudesElementsArray.length; i++) 
	{
		var elementName = roleAptitudesElementsArray[i];
		var elementValue = $(elementName).html();
		if(elementName.indexOf("select") >= 0) elementValue = $(elementName + " option:selected").val();
		var roleAptitudesElement = new Object();
		roleAptitudesElement.id= elementName;
		roleAptitudesElement.value= elementValue;
		data.roleAptitudesElements[i] = roleAptitudesElement;
	}
  
    data.skillArray = new Array();
	var cpt=0;
	$("#tbody_skills tr").each( function(){ 
		var rowName = $(this).attr("id");
		var rowId = rowName.split("_")[2];
		var skillId= $("#" + rowName  + "_td_name").data('skillid');
		var skillName = $("#" + rowName  + "_td_name").html();
		console.log( rowName  +' ' +skillId+' '+skillName );
		var skillRow = new Object();
		skillRow.Name = rowName;
		skillRow.skillId = skillId;
		skillRow.skillName = skillName;
		
		skillRow.Known = new Object();
		skillRow.Known.id = $("#checkbox_" + rowId + "_1").attr("id");
		skillRow.Known.value = $("#checkbox_" + rowId + "_1").prop("checked");
		
		skillRow.Trained = new Object();
		skillRow.Trained.id = $("#checkbox_" + rowId + "_2").attr("id");
		skillRow.Trained.value = $("#checkbox_" + rowId + "_2").prop("checked");
		
		skillRow.Experienced = new Object();
		skillRow.Experienced.id = $("#checkbox_" + rowId + "_3").attr("id");
		skillRow.Experienced.value = $("#checkbox_" + rowId + "_3").prop("checked");
		
		skillRow.Expert = new Object();
		skillRow.Expert.id = $("#checkbox_" + rowId + "_4").attr("id");
		skillRow.Expert.value = $("#checkbox_" + rowId + "_4").prop("checked");
		data.skillArray[cpt] = skillRow;
		
		cpt++
	});

	data.statArray = new Array();
	cpt=0;
	$("#tbody_stats tr").each( function(){ 
		var rowName = $(this).attr("id");
		var rowId = rowName.split("_")[2];
		var statId = $("#" + rowName  + "_td_name").data('statid');
		var statName = $("#" + rowName  + "_td_name").html();
		console.log( rowName  +' ' +statId+' '+statName );
		var statRow = new Object();
		statRow.Name = rowName;
		statRow.statId = statId;
		statRow.statName = statName;
		
		statRow.Simple = new Object();
		statRow.Simple.id = $("#checkbox_stat_" + rowId + "_1").attr("id");
		statRow.Simple.value = $("#checkbox_stat_" + rowId + "_1").prop("checked");
		
		statRow.Intermediate = new Object();
		statRow.Intermediate.id = $("#checkbox_stat_" + rowId + "_2").attr("id");
		statRow.Intermediate.value = $("#checkbox_stat_" + rowId + "_2").prop("checked");
		
		statRow.Trained = new Object();
		statRow.Trained.id = $("#checkbox_stat_" + rowId + "_3").attr("id");
		statRow.Trained.value = $("#checkbox_stat_" + rowId + "_3").prop("checked");
		
		statRow.Proficient = new Object();
		statRow.Proficient.id = $("#checkbox_stat_" + rowId + "_4").attr("id");
		statRow.Proficient.value = $("#checkbox_stat_" + rowId + "_4").prop("checked");
		
		statRow.Expert = new Object();
		statRow.Expert.id = $("#checkbox_stat_" + rowId + "_5").attr("id");
		statRow.Expert.value = $("#checkbox_stat_" + rowId + "_5").prop("checked");
		data.statArray[cpt] = statRow;
		
		cpt++
	});
	data.talentArray = new Array();
	 cpt=0;
	$("#tbody_talents_1 tr").each( function(){ 
		var rowName = $(this).attr("id");
		var rowId = rowName.split("_")[2];
		var talentId = $("#" + rowName  + "_td_name").data('talentid');
		var talentName = $("#" + rowName  + "_td_name").html();
		console.log( rowName  +' ' +talentId+' '+talentName );
		var talentRow = new Object();
		talentRow.Name = rowName;
		talentRow.talentId = talentId;
		talentRow.talentName = talentName;
		
		talentRow.Check = new Object();
		talentRow.Check.id = $("#checkbox_talent_" + rowId + "_1").attr("id");
		talentRow.Check.value = $("#checkbox_talent_" + rowId + "_1").prop("checked");
		
		data.talentArray[cpt] = talentRow;
		cpt++
	});	
	
	$("#tbody_traits input:checked").each( function(){
		data.trait.push(this.id);
	});
	
	console.log(data.trait);
	data.xpLeft = $('#input_exp').val();
	
	var plop = JSON.stringify(data);
	if(isSave)
	{
	  localStorage.setItem('save_pj', plop);
	}
	else{
		
		
		var csvString = plop;
		var a         = document.createElement('a');
		a.href        = 'data:attachment/csv,' + encodeURIComponent(csvString);
		a.target      = '_blank';
		a.download    = 'myFile.csv';

		document.body.appendChild(a);
		a.click();
	}
}

function LoadCharacterData(data){
	$('#input_exp').val(200000);
  //set gender
  if(data.gender == "M") $("#radio_gender_male").prop("checked", "checked");
  else $("#radio_gender_female").prop("checked", "checked");
  //set name
  if(data.name != null && data.name != "") $("#box_name").val(data.name);
  //set homeworld
  if(data.homeworld > -1) $("#select_world").val(data.homeworld).change();
  //set background
  if(data.background > -1) $("#select_background").val(data.background).change();
  //set background aptitude
  if(data.bg_aptitude > -1) $("#select_bgAptitude").val(data.bg_aptitude).change();
  //set role
  if(data.role > -1) $("#select_roles").val(data.role).change();
  //set role aptitude
  if(data.role == 0 && data.role_aptitude != null && data.role_aptitude != "") $("#select_role_apt_1").val(data.role_aptitude).change();
  //set Spécial aptitude
   $('#select_elite_advance').val(data.elite_aptitude).change(); 
  //////////////////////
  
  //set base stat points
  if(data.base_stat_points > 20) {
    $("#input_basepoints").val(data.base_stat_points);
    var basePoints = data.base_stat_points;
    for(var i = 0; i < statsArray.length; i++) {
      $("#box_stat_" + statsArray[i] + "_base").val(basePoints);
    }
  }
  //set weapon skill rolls
  if(data.stat_ws_1 > -1) $("#box_stat_ws_roll1").val(data.stat_ws_1);
  if(data.stat_ws_2 > -1) $("#box_stat_ws_roll2").val(data.stat_ws_2);
  //set ballistic skill rolls
  if(data.stat_bs_1 > -1) $("#box_stat_bs_roll1").val(data.stat_bs_1);
  if(data.stat_bs_2 > -1) $("#box_stat_bs_roll2").val(data.stat_bs_2);
  //set strength rolls
  if(data.stat_s_1 > -1) $("#box_stat_s_roll1").val(data.stat_s_1);
  if(data.stat_s_2 > -1) $("#box_stat_s_roll2").val(data.stat_s_2);
  //set toughness rolls
  if(data.stat_t_1 > -1) $("#box_stat_t_roll1").val(data.stat_t_1);
  if(data.stat_t_2 > -1) $("#box_stat_t_roll2").val(data.stat_t_2);
  //set agility rolls
  if(data.stat_ag_1 > -1) $("#box_stat_ag_roll1").val(data.stat_ag_1);
  if(data.stat_ag_2 > -1) $("#box_stat_ag_roll2").val(data.stat_ag_2);
  //set intelligence rolls
  if(data.stat_int_1 > -1) $("#box_stat_int_roll1").val(data.stat_int_1);
  if(data.stat_int_2 > -1) $("#box_stat_int_roll2").val(data.stat_int_2);
  //set percetion rolls
  if(data.stat_per_1 > -1) $("#box_stat_per_roll1").val(data.stat_per_1);
  if(data.stat_per_2 > -1) $("#box_stat_per_roll2").val(data.stat_per_2);
  //set willpower rolls
  if(data.stat_wil_1 > -1) $("#box_stat_wp_roll1").val(data.stat_wil_1);
  if(data.stat_wil_2 > -1) $("#box_stat_wp_roll2").val(data.stat_wil_2);
  //set fellowship rolls
  if(data.stat_fel_1 > -1) $("#box_stat_fel_roll1").val(data.stat_fel_1);
  if(data.stat_fel_2 > -1) $("#box_stat_fel_roll2").val(data.stat_fel_2);
  //set influence rolls
  if(data.stat_infl_1 > -1) $("#box_stat_infl_roll1").val(data.stat_infl_1);
  if(data.stat_infl_2 > -1) $("#box_stat_infl_roll2").val(data.stat_infl_2);
  //set wounds roll
  if(data.stat_wounds > -1) $("#box_stat_wounds_roll1").val(data.stat_wounds);
  //set fate points roll
  if(data.stat_fatepoints > -1) $("#box_stat_fate_roll1").val(data.stat_fatepoints);
  
  $('#td_divination').data("div_index",data.divination.id);
  $('#td_divination i').prop("title",data.divination.title);
  $('#td_divination i').html(data.divination.description);
	
  ////////////////////
  // RECALC ALL STATS!
  ReCalcStats();
  ////////////////////

  for(var i = 0; i < data.roleAptitudesElements.length; i++) 
	{
		var elementName = data.roleAptitudesElements[i].id;
		var elementValue = data.roleAptitudesElements[i].value;
		if(elementName.indexOf("select") >= 0) $(elementName).val(elementValue);
	}
	
  //load skills
	for(var i = 0; i < data.skillArray.length; i++) 
	{ 
		$('#select_skills').val(data.skillArray[i].skillId);
		$('#button_addskill').click();		
		if(data.skillArray[i].Known.value)
			$("#"+data.skillArray[i].Known.id).click();
		if(data.skillArray[i].Trained.value)
			$("#"+data.skillArray[i].Trained.id).click();
		if(data.skillArray[i].Experienced.value)
			$("#"+data.skillArray[i].Experienced.id).click();
		if(data.skillArray[i].Expert.value)
			$("#"+data.skillArray[i].Expert.id).click();
	};

  //load stat advances
	for(var i = 0; i < data.statArray.length; i++) 
	{ 
		$('#select_stats').val(data.statArray[i].statId);
		$('#button_addstat').click();		
		if(data.statArray[i].Simple.value)
			$("#"+data.statArray[i].Simple.id).click();
		if(data.statArray[i].Intermediate.value)
			$("#"+data.statArray[i].Intermediate.id).click();
		if(data.statArray[i].Trained.value)
			$("#"+data.statArray[i].Trained.id).click();
		if(data.statArray[i].Proficient.value)
			$("#"+data.statArray[i].Proficient.id).click();
		if(data.statArray[i].Expert.value)
			$("#"+data.statArray[i].Expert.id).click();
	};
  //load talent
	for(var i = 0; i < data.talentArray.length; i++) 
	{ 
		$('#select_talent_1').val(data.talentArray[i].talentId);
		$('#button_addtalent_1').click();		
		if(data.talentArray[i].Check.value)
			$("#"+data.talentArray[i].Check.id).click();
	};
	
	//load trait
	for(var i = 0; i < data.trait.length; i++) 
	{ 
		$('#'+data.trait[i]).click();
	}
	
	$('#input_exp').val(data.xpLeft);
};

function raz(){
$('#tbody_skills').html('');
$('#tbody_stats').html('');
$('#tbody_talents_1').html('');
$('#tbody_skills').html('');
 roleAptitudesElementsArray = new Array();
 globalAddedSkillCounter = 0;
 globalAddedStatCounter = 0;
 globalAddedTalentCounter = 0;
 existingRefundCost = 0;
//global status variables
 homeworldSelected = false;
 bgSelected = false;
 roleSelected = false;

}
/*
{"id":"1","gender":"male","name":"Enoch","homeworld":"3","divination":"10","background":"1","role":"0","assassin_role_apt":"Weapon Skill","bg_aptitude":"10","base_stat_points":"35","stat_ws_1":"10","stat_ws_2":"10","stat_bs_1":"10","stat_bs_2":"10","stat_s_1":"10","stat_s_2":"10","stat_t_1":"10","stat_t_2":"10","stat_ag_1":"10","stat_ag_2":"10","stat_int_1":"10","stat_int_2":"10","stat_per_1":"10","stat_per_2":"10","stat_wil_1":"10","stat_wil_2":"10","stat_fel_1":"10","stat_fel_2":"10","stat_infl_1":"10","stat_infl_2":"10","stat_wounds":"10","stat_fatepoints":"10"}

*/

</script>




</body></html>